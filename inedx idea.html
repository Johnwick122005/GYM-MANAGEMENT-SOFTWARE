<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymFlow - Complete Feature Prototype</title>
    <!-- SheetJS for Excel Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        /* ================================================= */
        /* DESIGN SYSTEM IMPLEMENTATION (Section 1) */
        /* ================================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        :root {
            /* Subtle / Professional Palette */
            --primary: #4B5563; /* slate */
            --primary-dark: #374151;
            --secondary: #64748B; /* muted blue-gray */
            --secondary-dark: #475569;

            /* Utility/Feedback Colors (muted) */
            --success: #16A34A; /* muted green */
            --success-light: rgba(22, 163, 74, 0.08);
            --warning: #D97706; /* amber (subtle) */
            --warning-light: rgba(217, 119, 6, 0.06);
            --danger: #DC2626; /* red */
            --danger-light: rgba(220, 38, 38, 0.06);
            --info: #0EA5A4; /* teal */
            --info-light: rgba(14, 165, 164, 0.06);

            /* Neutral/Theming Colors */
            --bg-primary: #F8FAFC; /* very light */
            --bg-secondary: #F1F5F9; /* sidebar/header soft */
            --bg-card: #FFFFFF;
            --text-primary: #0F1724; /* deep slate */
            --text-secondary: #6B7280; /* neutral gray */
            --border: #E6EEF3; /* soft border */

            /* Dark Mode Overrides (kept for later) */
        }

        /* Dark Mode CSS (Simplified for prototype) */
        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #334155;
            color: var(--text-primary);
        }

        body {
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            line-height: 1.6;
        }

        /* Utility helpers (small subset of missing utility classes used in markup) */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-3 { gap: 0.75rem; }
        .gap-12 { gap: 3rem; }
        .gap-16 { gap: 4rem; }
        .gap-24 { gap: 6rem; }

        /* Badge utilities for notifications */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            background: var(--danger);
            color: white;
            min-width: 20px;
            height: 20px;
        }

        /* Typography */
        h1, h2, h3, h4 {
            font-weight: 700;
            line-height: 1.3;
            letter-spacing: 0.5px;
            color: var(--text-primary);
        }
        h1 { font-size: 32px; }
        h2 { font-size: 24px; }
        h3 { font-size: 18px; }
        h4 { font-size: 14px; }

        /* Spacing & Borders */
        .card, .modal-content, .login-card {
            border-radius: 8px; /* Standard 8px radius */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Medium shadow */
        }

        /* ================================================= */
        /* 1.0 LOGIN PAGE STYLES - PREMIUM FUTURISTIC */
        /* ================================================= */
        .page-login {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, var(--secondary) 100%);
            position: relative;
            overflow: hidden;
        }

        .page-login::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .page-login::after {
            content: '';
            position: absolute;
            bottom: -50%;
            left: -50%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .login-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 48px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 420px;
            text-align: center;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.7);
            position: relative;
            z-index: 1;
        }

        .brand-logo {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 16px;
            margin: 0 auto 28px;
            font-size: 28px;
            font-weight: 700;
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.3);
        }

        .brand-name {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 18px;
            letter-spacing: 0.5px;
        }

        .brand-tagline {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .login-form label {
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 18px;
            margin-bottom: 8px;
            font-size: 14px;
            display: block;
            text-align: left;
            letter-spacing: 0.3px;
        }

        .login-form input {
            padding: 14px 16px;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.8) 100%);
            color: var(--text-primary);
            width: 100%;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.2);
            transform: translateY(-2px);
        }

        .btn-login {
            margin-top: 28px;
            padding: 14px;
            border-radius: 8px;
            font-weight: 700;
            width: 100%;
            letter-spacing: 0.5px;
        }


        /* ================================================= */
        /* 2.0 APP SHELL & NAVIGATION STYLES */
        /* ================================================= */
        .app-shell { display: flex; height: 100vh; }
        
        /* SIDEBAR - MODERN REDESIGN */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, rgba(243, 244, 246, 0.5) 100%);
            border-right: 1px solid var(--border);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: inset -1px 0 0 var(--border);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.3);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.5);
        }

        .sidebar-header {
            padding: 28px 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, transparent 100%);
        }

        .sidebar-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .sidebar-gym-name { font-weight: 700; font-size: 15px; color: var(--text-primary); margin-top: 8px; }
        .sidebar-plan { color: var(--text-secondary); font-size: 11px; margin-top: 2px; letter-spacing: 0.3px; }
        
        .sidebar-nav { padding: 20px 0; flex: 1; }
        .nav-section { margin-bottom: 24px; }
        .nav-section-title {
            padding: 0 24px; font-size: 10px; font-weight: 700; text-transform: uppercase;
            color: var(--text-secondary); letter-spacing: 0.6px; margin-bottom: 12px;
            opacity: 0.7;
        }

        .nav-link {
            padding: 12px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 0 12px;
            border-radius: 8px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 0%;
            background: var(--primary);
            border-radius: 0 2px 2px 0;
            transition: height 0.25s ease;
        }

        .nav-link:hover {
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            transform: translateX(4px);
        }

        .nav-link:hover::before {
            height: 60%;
        }

        .nav-link.active {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.15) 0%, rgba(37, 99, 235, 0.05) 100%);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-link.active::before {
            height: 80%;
        }

        .nav-link-logout { color: var(--danger); margin-top: auto; margin-bottom: 12px; }
        .nav-link-logout:hover { background: rgba(239, 68, 68, 0.12); }
        .nav-link-logout::before { background: var(--danger); }
        
        /* MAIN AREA & TOPBAR - Premium design */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .topbar {
            height: 72px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
            border-bottom: 1px solid rgba(75, 85, 99, 0.08);
            padding: 0 32px;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar-left { flex: 1; }
        .topbar-left h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.2px;
            margin: 0;
        }

        .topbar-right { gap: 20px; display: flex; align-items: center; }

        .topbar-item {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .owner-avatar {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, #64748B 0%, #475569 100%);
            font-size: 13px;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-radius: 50%;
        }

        /* CONTENT */
        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            background: linear-gradient(135deg, var(--bg-primary) 0%, rgba(243, 244, 246, 0.3) 100%);
        }

        .content::-webkit-scrollbar {
            width: 8px;
        }

        .content::-webkit-scrollbar-track {
            background: transparent;
        }

        .content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Add animation for notifications */
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        .view-header { margin-bottom: 32px; }
        .view-header h3 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.3px;
        }


        /* ================================================= */
        /* 3.0 GLOBAL COMPONENTS - PREMIUM FUTURISTIC */
        /* ================================================= */

        /* BUTTONS - Enhanced with gradient, glow effects */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s ease;
            z-index: 0;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            color: var(--text-primary);
            border: 1.5px solid rgba(37, 99, 235, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.15) 0%, rgba(37, 99, 235, 0.08) 100%);
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #D32F2F 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-sm { padding: 8px 14px; font-size: 12px; letter-spacing: 0.3px; }
        .btn-icon { width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; }

        /* CARDS - Premium glassmorphism design */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(37, 99, 235, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
            border-color: rgba(37, 99, 235, 0.3);
        }

        .card:hover::before {
            top: -20%;
            right: -20%;
        }

        .card h3 {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            font-weight: 700;
            opacity: 0.8;
        }

        .card-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .card-sub { font-size: 12px; color: var(--text-secondary); }
        .card-header { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
        .quick-actions { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
        .layout-two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .list { list-style: none; }
        .list li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            font-size: 14px;
            transition: all 0.25s ease;
        }
        .list li:hover { padding-left: 6px; color: var(--primary); }
        .list-alerts li { color: var(--danger); font-weight: 600; }
        
        /* TABLES - Modern premium design */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        }

        .table thead {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
            border-bottom: 2px solid rgba(37, 99, 235, 0.15);
        }

        .table th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }

        .table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            font-size: 14px;
            color: var(--text-primary);
        }

        .table tbody tr {
            transition: all 0.25s ease;
        }

        .table tbody tr:hover {
            background: rgba(37, 99, 235, 0.08);
            transform: scale(1.01);
            box-shadow: inset 0 0 8px rgba(37, 99, 235, 0.1);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* STATUS BADGES - Premium gradient design */
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            backdrop-filter: blur(10px);
        }

        .status-active, .status-paid, .status-converted {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-expiring, .status-due, .status-low, .status-trial, .status-contacted {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-expired, .status-overdue, .status-broken {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-frozen, .status-maintenance, .status-draft, .status-lost, .status-inactive {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.15) 0%, rgba(107, 114, 128, 0.05) 100%);
            color: var(--text-secondary);
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .status-new {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%);
            color: var(--info);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }
        
        /* FORMS & TOOLBAR - Modern glassmorphism */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toolbar input, .toolbar select, .form-control {
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.8) 100%);
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.25s ease;
            backdrop-filter: blur(10px);
        }

        .toolbar input:focus, .toolbar select:focus, .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.2);
            transform: translateY(-2px);
        }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .form-control { width: 100%; }

        /* TABS - Modern underline design */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }

        .tab {
            padding: 14px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            letter-spacing: 0.3px;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        /* MODAL - Premium glassmorphism */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(-50px) scale(0.95);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .modal.open .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-footer {
            margin-top: 28px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.25s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .close-modal:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--primary);
            transform: rotate(90deg) scale(1.1);
        }

        /* DETAIL PANEL - Premium sliding design */
        .detail-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 450px;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-primary) 0%, rgba(255, 255, 255, 0.8) 100%);
            z-index: 900;
            box-shadow: -8px 0 24px rgba(0, 0, 0, 0.12);
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 32px;
            overflow-y: auto;
            border-left: 1px solid rgba(0, 0, 0, 0.05);
        }

        .detail-panel.open {
            transform: translateX(0);
        }

        .panel-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 28px;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(37, 99, 235, 0.2);
            letter-spacing: 0.3px;
        }

        .detail-panel p { margin-bottom: 10px; font-size: 14px; line-height: 1.6; }
        .detail-panel strong { color: var(--primary); font-weight: 600; }
        .detail-panel .quick-actions { margin-top: 18px; }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .sidebar { width: 240px; }
            .layout-two-column { grid-template-columns: 1fr; }
            .topbar { padding: 0 16px; }
            .nav-link { padding: 11px 20px; font-size: 13px; margin: 0 8px; }
            .nav-section-title { padding: 0 20px; }
        }

        @media (max-width: 768px) {
            .app-shell { flex-direction: column; }
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 80px;
                border-right: none;
                border-bottom: 1px solid var(--border);
                flex-direction: row;
                align-items: center;
                background: linear-gradient(90deg, var(--bg-secondary) 0%, rgba(243, 244, 246, 0.5) 100%);
                padding: 12px 20px;
            }
            .sidebar-header {
                padding: 0;
                border-bottom: none;
                background: none;
                flex-direction: row;
            }
            .sidebar-logo { width: 40px; height: 40px; font-size: 16px; }
            .sidebar-gym-name { font-size: 14px; margin-top: 0; }
            .sidebar-plan { display: none; }
            .sidebar-nav { padding: 0; flex-direction: row; display: none; }
            .nav-section { display: none; }
            .topbar { padding: 0 16px; }
            .topbar-left h2 { font-size: 18px; }
            .content { padding: 16px; }
            .cards-grid { grid-template-columns: 1fr; }
            .detail-panel { width: 100%; }
        }
    </style>
</head>
<body class="light-mode">
    <div id="app-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modal-title" aria-describedby="modal-body">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button type="button" class="close-modal" onclick="closeModal()" aria-label="Close modal">×</button>
            </div>
            <div id="modal-body">
                </div>
            <div class="modal-footer" id="modal-footer">
                </div>
        </div>
    </div>
    
    <div id="member-detail-panel" class="detail-panel" role="dialog" aria-modal="false" aria-hidden="true" aria-labelledby="panel-member-name" tabindex="-1">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 id="panel-member-name">John Doe</h3>
            <button type="button" class="close-modal" onclick="closeDetailPanel()" aria-label="Close detail panel">×</button>
        </div>
        
        <div id="panel-member-content"></div>
    </div>

    <div id="login-page" class="page-login">
        <div class="login-card">
            <div class="brand-logo flex items-center justify-center">GF</div>
            <h2 class="brand-name">GymFlow</h2>
            <p class="brand-tagline">Smart Gym Management Platform</p>
            <form id="login-form" class="login-form">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="owner@gym.com" value="owner@gym.com" required class="form-control">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="••••••••" value="password" required class="form-control">
                <div style="display:flex; justify-content:flex-end; margin-top:8px;">
                    <a href="#" onclick="showModal('forgotPassword')" style="font-size:12px; color:var(--primary); text-decoration:none;">Forgot Password?</a>
                </div>
                <button type="submit" class="btn btn-primary btn-login">Login</button>
                <p class="login-hint" style="color: var(--text-secondary); margin-top: 16px;">Demo Account — no backend authentication</p>
            </form>
        </div>
    </div>

    <div id="app" class="app-shell hidden" tabindex="0">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="sidebar-logo flex items-center justify-center" id="gym-logo">GF</div>
                    <div style="flex: 1;">
                        <div class="sidebar-gym-name" id="gym-name-display">My Fitness Gym</div>
                        <small class="sidebar-plan">Owner Panel</small>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <a class="nav-link active" data-view="dashboard" onclick="switchView('dashboard')">Dashboard</a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Core Management</div>
                    <a class="nav-link" data-view="members" onclick="switchView('members')">Members</a>
                    <a class="nav-link" data-view="classes" onclick="switchView('classes')">Classes & Schedule</a>
                    <a class="nav-link" data-view="calendar" onclick="switchView('calendar')">Calendar</a>
                    <a class="nav-link" data-view="plans" onclick="switchView('plans')">Membership Plans</a>
                    <a class="nav-link" data-view="staff" onclick="switchView('staff')">Staff Management</a>
                    <a class="nav-link" data-view="staff-schedule" onclick="switchView('staff-schedule')">Staff Schedule</a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Financial & Sales</div>
                    <a class="nav-link" data-view="billing" onclick="switchView('billing')">Billing & Payments</a>
                    <a class="nav-link" data-view="leads" onclick="switchView('leads')">Lead Management (CRM)</a>
                    <a class="nav-link" data-view="reports" onclick="switchView('reports')">Reports & Analytics</a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a class="nav-link" data-view="attendance" onclick="switchView('attendance')">Attendance & Check-in</a>
                    <a class="nav-link" data-view="equipment" onclick="switchView('equipment')">Equipment & Maintenance</a>
                    <a class="nav-link" data-view="inventory" onclick="switchView('inventory')">Inventory & POS</a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <a class="nav-link" data-view="settings" onclick="switchView('settings')">Settings</a>
                    <a class="nav-link" data-view="feedback" onclick="switchView('feedback')">Feedback</a>
                    <button class="nav-link nav-link-logout" id="logout-btn">Logout</button>
                </div>
            </nav>
        </aside>

        <div class="main">
            <header class="topbar">
                <div class="topbar-left">
                    <h2 id="current-view-title">Dashboard</h2>
                </div>
                <div class="topbar-right">
                    <div class="topbar-item" id="today-date">Dec 11, 2025</div>
                    <div style="width: 1px; height: 24px; background: rgba(0, 0, 0, 0.08);"></div>
                    <div class="topbar-item flex items-center" style="gap: 10px;">
                        <span id="topbar-username">Owner</span>
                        <div class="owner-avatar flex items-center justify-center" onclick="showModal('profile')" style="cursor: pointer;" id="topbar-avatar">O</div>
                    </div>
                </div>
            </header>

            <main class="content">
                <!-- 1. DASHBOARD: Real-time business KPIs and overview -->
                <section id="view-dashboard" class="view active">
                    <div class="cards-grid">
                        <div class="card">
                            <h3>Active Members</h3>
                            <div class="card-value" id="stat-active-members">128 <span style="font-size: 16px; color: var(--success);">↑ 15%</span></div>
                            <p class="card-sub">Target: 150 (87% complete)</p>
                        </div>
                        <div class="card">
                            <h3>Monthly Revenue (MRR)</h3>
                            <div class="card-value" id="stat-revenue">₹3,20,000 <span style="font-size: 16px; color: var(--success);">↑ 8%</span></div>
                            <p class="card-sub">Target: ₹4,00,000</p>
                        </div>
                        <div class="card">
                            <h3>Retention Rate</h3>
                            <div class="card-value" id="stat-retention">92% <span style="font-size: 16px; color: var(--success);">↑ 2%</span></div>
                            <p class="card-sub">Industry Avg: 90% (Good)</p>
                        </div>
                        <div class="card">
                            <h3>Outstanding Dues</h3>
                            <div class="card-value">₹15,000 <span style="font-size: 16px; color: var(--danger);">↓ 5%</span></div>
                            <p class="card-sub">10 days overdue</p>
                        </div>
                    </div>

                    <div class="layout-two-column" style="margin-bottom: 32px;">
                        <div class="card">
                            <div class="card-header"><h3>Revenue Trend (12 Months)</h3></div>
                            <div style="height: 200px; background: rgba(37, 99, 235, 0.05); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">[LINE CHART PLACEHOLDER]</div>
                            <p style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">Revenue stable around ₹3.2L/month.</p>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Member Growth</h3></div>
                            <div style="height: 200px; background: rgba(139, 92, 246, 0.05); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">[AREA CHART PLACEHOLDER]</div>
                            <p style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">Strong growth in Q4 2024.</p>
                        </div>
                    </div>

                    <div class="layout-two-column">
                        <div class="card">
                            <div class="card-header"><h3>Quick Actions (1.4)</h3></div>
                            <div class="quick-actions" style="display: grid; grid-template-columns: 1fr 1fr;">
                                <button class="btn btn-primary btn-sm" onclick="showModal('addMember')">+ New Member</button>
                                <button class="btn btn-primary btn-sm" onclick="showModal('recordPayment')">+ Record Payment</button>
                                <button class="btn btn-primary btn-sm" onclick="showModal('createClass')">+ Create Class</button>
                                <button class="btn btn-secondary btn-sm" onclick="showModal('addEquipment')">+ Add Equipment</button>
                                <button class="btn btn-secondary btn-sm" onclick="showModal('sendCampaign')">+ Send Campaign</button>
                                <button class="btn btn-secondary btn-sm" onclick="showModal('addTask')">+ Add Task</button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>Pending Tasks</h3>
                                <button class="btn btn-sm btn-secondary" onclick="showModal('addTask')">+</button>
                            </div>
                            <ul class="list" id="dashboard-tasks-list">
                                <!-- Populated by JS -->
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- 2. MEMBERS: Member database and lifecycle management -->
                <section id="view-members" class="view">
                    <div class="view-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Members Management</h3>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-primary" onclick="showModal('addMember')">+ Add Member</button>
                            <button id="import-members-btn" class="btn btn-secondary btn-sm" onclick="showModal('importMembers')">Import</button>
                            <button class="btn btn-secondary btn-sm" onclick="handleBulkAction('export')">Export</button>
                            <button id="bulk-send-sms-btn" class="btn btn-secondary btn-sm" onclick="if(selectedMembers && selectedMembers.size > 0) { showModal('sendBulkSMS'); } else { showNotification('Please select members to send SMS to.', 'warning', 2500); }" disabled>Send SMS</button>
                        </div>
                    </div>
                    <div class="toolbar">
                        <input type="search" id="search-members" placeholder="Search by name, phone, ID" class="form-control" style="width: 280px;" onkeyup="filterMembers()">
                        <select id="filter-members-status" class="form-control" onchange="filterMembers()">
                            <option value="">Status: All</option>
                            <option value="active">Active</option>
                            <option value="expiring">Expiring</option>
                            <option value="expired">Expired</option>
                            <option value="frozen">Frozen</option>
                            <option value="trial">Trial</option>
                        </select>
                        <select id="filter-members-plan" class="form-control">
                            <option value="">Plan: All</option>
                            <option value="premium">12-Month Premium</option>
                            <option value="standard">6-Month Standard</option>
                        </select>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-members"></th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Plan</th>
                                <th>Expiry Date</th>
                                <th>Engagement</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="members-table-body">
                            <tr data-member-id="john-doe" onclick="openDetailPanel('member')">
                                <td><input type="checkbox" class="member-select" data-member-id="john-doe" onclick="event.stopPropagation(); toggleSelectMember(this)"></td>
                                <td>John Doe</td>
                                <td>98765-43210</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>12-Month Premium</td>
                                <td>15-Dec-2025 (8 days)</td>
                                <td><span style="color: var(--success); font-weight: 700;">8.5/10</span></td>
                                <td><button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showModal('editMember', 'John Doe')">Edit</button></td>
                            </tr>
                            <tr data-member-id="sarah-khan" onclick="openDetailPanel('member')">
                                <td><input type="checkbox" class="member-select" data-member-id="sarah-khan" onclick="event.stopPropagation(); toggleSelectMember(this)"></td>
                                <td>Sarah Khan</td>
                                <td>94567-12345</td>
                                <td><span class="status-badge status-expiring">Expiring</span></td>
                                <td>6-Month Standard</td>
                                <td>18-Dec-2025 (11 days)</td>
                                <td><span style="color: var(--warning); font-weight: 700;">5.2/10</span></td>
                                <td><button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showModal('editMember', 'Sarah Khan')">Edit</button></td>
                            </tr>
                            <tr data-member-id="mike-singh" onclick="openDetailPanel('member')">
                                <td><input type="checkbox" class="member-select" data-member-id="mike-singh" onclick="event.stopPropagation(); toggleSelectMember(this)"></td>
                                <td>Mike Singh</td>
                                <td>96789-54321</td>
                                <td><span class="status-badge status-expired">Expired</span></td>
                                <td>Basic</td>
                                <td>30-Oct-2025 (Expired)</td>
                                <td><span style="color: var(--danger); font-weight: 700;">2.1/10</span></td>
                                <td><button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showModal('editMember', 'Mike Singh')">Edit</button></td>
                            </tr>
                            <tr data-member-id="priya-patel" onclick="openDetailPanel('member')">
                                <td><input type="checkbox" class="member-select" data-member-id="priya-patel" onclick="event.stopPropagation(); toggleSelectMember(this)"></td>
                                <td>Priya Patel</td>
                                <td>97654-32109</td>
                                <td><span class="status-badge status-frozen">Frozen</span></td>
                                <td>12-Month Premium</td>
                                <td>15-Mar-2026</td>
                                <td><span style="color: var(--success); font-weight: 700;">7.9/10</span></td>
                                <td><button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showModal('editMember', 'Priya Patel')">Edit</button></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Hidden import inputs used by Import Members modal -->
                    <input type="file" id="import-members-excel" accept=".xlsx,.xls,.csv" style="display:none">
                    <input type="file" id="import-members-images" accept="image/*" style="display:none" multiple>
                    <p style="margin-top: 16px; font-size: 12px; color: var(--text-secondary);">Showing 1-10 of 128 members | [Pagination Placeholder]</p>
                </section>
                
                <!-- 3. BILLING & PAYMENTS: Invoice and revenue collection management -->
                <section id="view-billing" class="view">
                    <div class="view-header">
                        <h3>Billing & Payments</h3>
                        <button class="btn btn-primary" onclick="showModal('recordPayment')">+ Record Payment</button>
                    </div>
                    <div class="cards-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 12px; margin-bottom: 4px;">Monthly Revenue</h4>
                            <div class="card-value" style="font-size: 24px;">₹3.2L <span style="font-size: 14px; color: var(--success);">↑ 8%</span></div>
                        </div>
                         <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 12px; margin-bottom: 4px;">Unpaid Invoices</h4>
                            <div class="card-value" style="font-size: 24px;">₹15k <span style="font-size: 14px; color: var(--warning);">↑ 2</span></div>
                        </div>
                         <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 12px; margin-bottom: 4px;">Overdue Amount</h4>
                            <div class="card-value" style="font-size: 24px;">₹8k <span style="font-size: 14px; color: var(--success);">↓ 5k</span></div>
                        </div>
                         <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 12px; margin-bottom: 4px;">Collection Efficiency</h4>
                            <div class="card-value" style="font-size: 24px;">94% <span style="font-size: 14px; color: var(--success);">↑ 2%</span></div>
                        </div>
                    </div>
                    
                    <div class="toolbar">
                        <input type="search" placeholder="Search Invoice# or Member" class="form-control" style="width: 250px;">
                        <select class="form-control">
                            <option value="">Status: All</option>
                            <option value="paid">Paid</option>
                            <option value="due">Due</option>
                            <option value="overdue">Overdue</option>
                        </select>
                        <button class="btn btn-secondary">Bulk Reminders</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice#</th>
                                <th>Member</th>
                                <th>Plan</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billing-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </section>
                
                <!-- 4. ATTENDANCE & CHECK-IN: Member visit tracking and analytics -->
                <section id="view-attendance" class="view">
                    <div class="view-header">
                        <h3>Attendance & Check-in</h3>
                        <button class="btn btn-primary" onclick="showModal('checkin')">+ Quick Check-in</button>
                    </div>
                    <div class="cards-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                        <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 12px; margin-bottom: 4px;">Total Check-ins</h4>
                            <div class="card-value" style="font-size: 24px;">24</div>
                        </div>
                         <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 12px; margin-bottom: 4px;">Currently In Gym</h4>
                            <div class="card-value" style="font-size: 24px;">8</div>
                        </div>
                         <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 12px; margin-bottom: 4px;">Peak Hour</h4>
                            <div class="card-value" style="font-size: 24px;">6-7 AM</div>
                        </div>
                         <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 12px; margin-bottom: 4px;">Avg Visit Duration</h4>
                            <div class="card-value" style="font-size: 24px;">1h 15m</div>
                        </div>
                    </div>
                    
                    <div class="toolbar">
                        <input type="search" placeholder="Search member by ID or Name" class="form-control" style="width: 250px;">
                        <input type="date" value="2025-12-11" class="form-control">
                        <button class="btn btn-secondary">View History</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Member</th>
                                <th>Check-out</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </section>
                
                <!-- 5. CLASSES & SCHEDULING: Class management and member bookings -->
                <section id="view-classes" class="view">
                    <div class="view-header">
                        <h3>Classes & Schedule</h3>
                        <button class="btn btn-primary" onclick="showModal('createClass')">+ Create Class</button>
                    </div>
                    <div class="layout-two-column">
                        <div>
                            <h4 style="margin-bottom: 16px; font-size: 18px;">Classes List</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Class</th>
                                        <th>Time</th>
                                        <th>Trainer</th>
                                        <th>Booked/Cap</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="classes-table-body">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <button class="btn btn-secondary btn-sm" style="margin-top: 16px;" onclick="alert('Viewing class analytics...')">View Class Analytics</button>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 16px; font-size: 18px;">Weekly Schedule</h4>
                            <div class="card" style="padding: 16px;">
                                <p><strong>Mon:</strong> Yoga (6 AM), Zumba (6:30 AM), CrossFit (7 AM), Cardio (6 PM), Spin (7 PM)</p>
                                <p><strong>Tue:</strong> Yoga (6 AM), Zumba (6:30 AM), CrossFit (7 AM), Cardio (6 PM), Spin (7 PM)</p>
                                <p><strong>Sat:</strong> Cardio (6:30 AM), Pilates (4 PM)</p>
                                <p style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">Green: Plenty of space. Red: Full.</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" style="margin-top: 16px;" onclick="alert('Opening calendar view...')">View Calendar</button>
                        </div>
                    </div>
                </section>
                
                <!-- NEW CALENDAR SECTION -->
                <section id="view-calendar" class="view">
                    <div class="view-header">
                        <h3>Calendar</h3>
                        <button class="btn btn-primary" onclick="showModal('createClass')">+ Add Class</button>
                    </div>
                    <div class="card" style="padding: 20px;">
                        <div id='calendar'></div>
                    </div>
                </section>

                <!-- 6. STAFF MANAGEMENT: Employee records and role assignment -->
                <section id="view-staff" class="view">
                    <div class="view-header">
                        <h3>Staff Management</h3>
                        <button class="btn btn-primary" onclick="showModal('addStaff')">+ Add Staff Member</button>
                    </div>
                    <div class="toolbar">
                        <select class="form-control">
                            <option value="">Role: All</option>
                            <option value="trainer">Trainer</option>
                            <option value="manager">Manager</option>
                            <option value="receptionist">Receptionist</option>
                        </select>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Performance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staff-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </section>
                
                <!-- NEW STAFF SCHEDULE SECTION -->
                <section id="view-staff-schedule" class="view">
                    <div class="view-header">
                        <h3>Staff Schedule</h3>
                        <button class="btn btn-primary" onclick="showModal('assignShift')">+ Assign Shift</button>
                    </div>
                    <div class="card" style="padding: 20px;">
                        <div id='staff-calendar'></div>
                    </div>
                </section>
                
                <!-- 7. MEMBERSHIP PLANS: Plan creation and customization -->
                <section id="view-plans" class="view">
                    <div class="view-header">
                        <h3>Membership Plans</h3>
                        <button class="btn btn-primary" onclick="showModal('addPlan')">+ Add New Plan</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Plan Name</th>
                                <th>Duration</th>
                                <th>Price</th>
                                <th>Active Members</th>
                                <th>Renewal Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="plans-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </section>
                
                <!-- 8. EQUIPMENT & MAINTENANCE: Equipment inventory and service tracking -->
                <section id="view-equipment" class="view">
                    <div class="view-header">
                        <h3>Equipment Management</h3>
                        <button class="btn btn-primary" onclick="showModal('addEquipment')">+ Add Equipment</button>
                    </div>
                    <div class="toolbar">
                         <select class="form-control">
                            <option value="">Status: All</option>
                            <option value="active">Active</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="broken">Broken</option>
                        </select>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Purchase Date</th>
                                <th>Status</th>
                                <th>Next Maintenance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="equipment-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </section>
                
                <!-- 9. INVENTORY & POS: Product sales and inventory management -->
                <section id="view-inventory" class="view">
                    <div class="view-header">
                        <h3>Inventory & POS</h3>
                        <button class="btn btn-primary" onclick="showModal('openPOS')">Open POS</button>
                    </div>
                    <h4 style="margin-bottom: 16px;">Inventory List</h4>
                    <div class="toolbar">
                        <input type="search" placeholder="Search Product or SKU" class="form-control" style="width: 250px;">
                        <select class="form-control">
                            <option value="">Stock: All</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                        </select>
                        <button class="btn btn-secondary" onclick="showModal('addProduct')">+ Add Product</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Price</th>
                                <th>Sale (Today)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </section>
                
                <!-- 10. LEAD MANAGEMENT: Sales pipeline and prospect tracking -->
                <section id="view-leads" class="view">
                    <div class="view-header">
                        <h3>Lead Management (CRM)</h3>
                        <button class="btn btn-primary" onclick="showModal('addLead')">+ Add New Lead</button>
                    </div>
                    <div class="toolbar">
                        <select class="form-control">
                            <option value="">Status: All</option>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="trial">Trial</option>
                            <option value="converted">Converted</option>
                        </select>
                         <button class="btn btn-secondary" onclick="showModal('campaignBuilder')">Bulk Campaign</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Next Follow-up</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </section>
                
                <!-- 11. REPORTS & ANALYTICS: Comprehensive business insights -->
                <section id="view-reports" class="view">
                    <div class="view-header">
                        <h3>Reports & Analytics</h3>
                        <button class="btn btn-secondary" onclick="showModal('customReport')">Generate Custom Report</button>
                    </div>
                    <div class="cards-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="card" style="border-left: 4px solid var(--primary);">
                            <div class="card-header"><h4>FINANCIAL</h4></div>
                            <p style="font-size: 14px;">Revenue: ₹3.2L <span style="color: var(--success);">▲</span></p>
                            <p style="font-size: 14px;">Profit: ₹1.6L <span style="color: var(--success);">▲</span></p>
                            <p style="font-size: 14px;">Collection Rate: 94%</p>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--secondary);">
                            <div class="card-header"><h4>MEMBER INSIGHTS</h4></div>
                            <p style="font-size: 14px;">Total: 128 <span style="color: var(--success);">▲</span></p>
                            <p style="font-size: 14px;">Churn Rate: 8%</p>
                            <p style="font-size: 14px;">Retention: 92%</p>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--success);">
                            <div class="card-header"><h4>ATTENDANCE</h4></div>
                            <p style="font-size: 14px;">Daily Avg: 24</p>
                            <p style="font-size: 14px;">Peak Time: 7 AM</p>
                            <p style="font-size: 14px;">At Risk: 3 members</p>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--warning);">
                            <div class="card-header"><h4>OPERATIONS</h4></div>
                            <p style="font-size: 14px;">Classes: 35/month</p>
                            <p style="font-size: 14px;">Utilization: 68%</p>
                            <p style="font-size: 14px;">Maintenance: 2 due</p>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 24px; margin-bottom: 16px;">Financial Performance Report (11.2 Mockup)</h4>
                    <div class="card" style="padding: 24px;">
                        <p style="font-size: 14px;"><strong>TOTAL INCOME:</strong> ₹3,16,900</p>
                        <p style="font-size: 14px;"><strong>TOTAL EXPENSES:</strong> ₹2,17,500</p>
                        <p style="font-size: 16px; font-weight: 700; margin-top: 12px;">GROSS PROFIT: ₹99,400 (31.4% margin)</p>
                        <ul class="list" style="margin-top: 16px;">
                            <li style="color: var(--danger); font-size: 12px;">Monitor: Revenue slightly down 1% vs last month</li>
                            <li style="color: var(--success); font-size: 12px;">Strong: Collection rate 94% (above 90% target)</li>
                            <li style="color: var(--primary); font-size: 12px;">Action: Follow up on ₹15k overdue payments</li>
                        </ul>
                        <div class="quick-actions">
                            <button class="btn btn-sm btn-secondary" onclick="alert('Exporting PDF...')">Export PDF</button>
                            <button class="btn btn-sm btn-secondary" onclick="alert('Exporting Excel...')">Export Excel</button>
                            <button class="btn btn-sm btn-secondary" onclick="alert('Emailing report...')">Email Report</button>

                    <div class="layout-two-column" style="margin-top: 24px;">
                        <div class="card">
                            <div class="card-header"><h3>Monthly Revenue</h3></div>
                            <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Attendance Trends</h3></div>
                            <canvas id="attendanceChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </section>
                
                <!-- 12. NOTIFICATIONS & AUTOMATION: Smart alerts and campaigns -->
                <section id="view-notifications" class="view">
                    <div class="view-header">
                        <h3>Notification Center</h3>
                        <button class="btn btn-secondary" onclick="showModal('notificationSettings')">Settings</button>
                    </div>
                    <div class="card" style="max-width: 600px;">
                        <h4 style="margin-bottom: 16px;">Recent Alerts</h4>
                        <ul class="list" id="notifications-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    
                    <h4 style="margin-top: 32px; margin-bottom: 16px;">Automation & Campaign Templates (12.2)</h4>
                    <div class="card" style="max-width: 600px;">
                        <p><strong>Membership Expiry Reminder:</strong> Sent 7 days before expiry via SMS + Email.</p>
                        <p><strong>Low Stock Alert:</strong> Sent to Manager when inventory is below threshold.</p>
                        <p><strong>Lead Follow-up Due:</strong> Sent to Sales Manager for overdue follow-ups.</p>
                        <button class="btn btn-sm btn-secondary" style="margin-top: 12px;" onclick="showModal('campaignBuilder')">Manage Campaigns</button>
                    </div>
                </section>

                <!-- 13.5 FEEDBACK (Owner View) -->
                <section id="view-feedback" class="view">
                    <div class="view-header">
                        <h3>Member Feedback</h3>
                    </div>
                    <div class="card">
                        <table class="table">
                            <thead><tr><th>Date</th><th>Type</th><th>Message</th><th>Status</th></tr></thead>
                            <tbody id="feedback-table-body"></tbody>
                        </table>
                    </div>
                </section>

                <!-- 13. SETTINGS & CONFIGURATION: Gym customization and user management -->
                <section id="view-settings" class="view">
                    <div class="view-header">
                        <h3>Settings & Configuration</h3>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" data-settings-tab="general" onclick="switchSettingsTab('general')">Gym Information</button>
                        <button class="tab" data-settings-tab="user" onclick="switchSettingsTab('user')">User Access & Roles</button>
                        <button class="tab" data-settings-tab="personal" onclick="switchSettingsTab('personal')">Personal</button>
                        <button class="tab" data-settings-tab="integrations" onclick="switchSettingsTab('integrations')">Integration Hub</button>
                    </div>

                    <div class="settings-panel active" id="settings-general">
                        <h4 style="margin-bottom: 20px;">Gym Basic Information & Branding</h4>
                        <div class="form-group"><label>Gym Name *</label><input type="text" id="set-gym-name" class="form-control" style="max-width: 400px;"></div>
                        <div class="form-group"><label>Email *</label><input type="email" id="set-gym-email" class="form-control" style="max-width: 400px;"></div>
                        <div class="form-group"><label>Phone *</label><input type="text" id="set-gym-phone" class="form-control" style="max-width: 400px;"></div>
                        <div class="form-group"><label>Address</label><input type="text" id="set-gym-address" class="form-control" style="max-width: 400px;"></div>
                        
                        <h4 style="margin-top: 32px; margin-bottom: 20px;">Branding</h4>
                        <div class="form-group"><label>Primary Color</label><input type="color" id="set-gym-color" value="#2563EB" class="form-control" style="max-width: 400px; height: 40px;"></div>
                        <div class="form-group"><label>Theme</label>
                            <select id="set-gym-theme" class="form-control" style="max-width: 400px;">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
                    </div>

                    <div class="settings-panel" id="settings-user">
                        <h4 style="margin-bottom: 20px;">User Roles & Permissions</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Access</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Owner</td>
                                    <td>Owner</td>
                                    <td>Full Access</td>
                                    <td><span class="status-badge status-active">Active</span></td>
                                    <td><button class="btn btn-sm btn-secondary">Edit Permissions</button></td>
                                </tr>
                                <tr>
                                    <td>Sarah Khan</td>
                                    <td>Manager</td>
                                    <td>Partial (No Settings)</td>
                                    <td><span class="status-badge status-active">Active</span></td>
                                    <td><button class="btn btn-sm btn-secondary">Edit Permissions</button></td>
                                </tr>
                                <tr>
                                    <td>Rahul Kumar</td>
                                    <td>Trainer</td>
                                    <td>Limited (View Classes)</td>
                                    <td><span class="status-badge status-active">Active</span></td>
                                    <td><button class="btn btn-sm btn-secondary">Edit Permissions</button></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <h4 style="margin-top: 32px; margin-bottom: 20px;">Add New User</h4>
                        <div style="display: flex; gap: 12px; max-width: 600px;">
                            <input type="email" placeholder="Email" class="form-control" style="flex: 2;">
                            <select class="form-control" style="flex: 1;">
                                <option>Manager</option>
                                <option>Trainer</option>
                                <option>Receptionist</option>
                            </select>
                            <button class="btn btn-primary" style="flex: 1;" onclick="alert('Sending invite...')">Send Invite</button>
                        </div>
                    </div>
                    
                    <div class="settings-panel" id="settings-personal">
                        <h4 style="margin-bottom: 20px;">Interface Preferences</h4>
                        <div class="form-group"><label>Dark Mode</label>
                            <select id="personal-theme-select" class="form-control" style="max-width: 400px;" onchange="savePersonalTheme()">
                                <option value="light">Light (Default)</option>
                                <option value="dark">Dark Mode</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-panel" id="settings-integrations">
                        <h4 style="margin-bottom: 20px;">Payment Gateways</h4>
                        <div class="card" style="padding: 16px; margin-bottom: 16px;">
                            <p style="font-weight: 600; color: var(--text-primary);">Razorpay <span style="font-size: 12px; color: var(--success); margin-left: 8px;">(Connected)</span></p>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Status: Active | Last sync: 5 min ago</p>
                            <button class="btn btn-sm btn-secondary" style="margin-top: 12px;" onclick="showModal('razorpaySettings')">View Details</button>
                        </div>
                        <div class="card" style="padding: 16px;">
                            <p style="font-weight: 600; color: var(--text-primary);">Stripe <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">(Not Connected)</span></p>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Features: Payments, recurring, refunds</p>
                            <button class="btn btn-sm btn-primary" style="margin-top: 12px;" onclick="showModal('connectStripe')">Connect Now</button>
                        </div>
                        
                        <h4 style="margin-top: 32px; margin-bottom: 20px;">Communication</h4>
                        <div class="card" style="padding: 16px;">
                            <p style="font-weight: 600; color: var(--text-primary);">Twilio SMS <span style="font-size: 12px; color: var(--success); margin-left: 8px;">(Connected)</span></p>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Balance: ₹2,500 (Low) | Messages sent: 542</p>
                            <button class="btn btn-sm btn-secondary" style="margin-top: 12px;" onclick="alert('Opening Twilio settings...')">Top-up Balance</button>
                        </div>
                    </div>
                </section>
                
                <section id="view-mobile" class="view" style="display: none;">
                    </section>
                
                <!-- 14. MEMBER PORTAL: View for logged-in members -->
                <section id="view-member-portal" class="view" style="display: none;">
                    <div class="view-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>My Member Portal</h3>
                    </div>
                    <div class="layout-two-column">
                        <div class="card">
                            <div class="card-header"><h3>My Attendance History</h3></div>
                            <table class="table">
                                <thead><tr><th>Date</th><th>Check-in</th><th>Duration</th></tr></thead>
                                <tbody id="member-attendance-body"></tbody>
                            </table>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Upcoming Classes</h3></div>
                            <ul class="list" id="member-classes-list"></ul>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header"><h3>🏆 Community Leaderboard (Top 10)</h3></div>
                        <table class="table">
                            <thead><tr><th>Rank</th><th>Member</th><th>Total Visits</th></tr></thead>
                            <tbody id="leaderboard-table-body"></tbody>
                        </table>
                    </div>
                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header"><h3>Feedback & Support</h3></div>
                        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:12px;">Have a suggestion or complaint? Let us know anonymously.</p>
                        <button class="btn btn-primary btn-sm" onclick="showModal('submitFeedback')">Submit Feedback</button>
                    </div>
                    </section>
            </main>
        </div>
    </div>

    <script>
        // ============ APP STATE & DATA ============

        // CONFIGURATION: Point this to your backend server
        // If running backend locally on port 5000, use 'http://localhost:5000/api'
        const API_BASE_URL = '/api'; 

        /* 
           BACKEND API REQUIREMENTS (To Build):
           [POST]   /auth/login          -> { email, password }
           [GET]    /members             -> Returns [] of members
           [POST]   /members             -> Create member
           [DELETE] /members/:id         -> Delete member
           [GET]    /dashboard-stats     -> { activeMembers, revenue }
           [POST]   /classes             -> Create class
           [POST]   /staff               -> Create staff
           [GET]    /plans               -> Membership plans
           [GET]    /invoices            -> Billing
           [GET]    /leads               -> CRM
           [GET]    /equipment           -> Equipment
           [GET]    /inventory           -> Products
           [GET]    /reports/revenue     -> Revenue Chart Data
           [GET]    /reports/attendance  -> Attendance Chart Data
           [GET]    /settings            -> Gym Configuration
           [GET]    /tasks               -> Task Management
           [POST]   /tasks               -> Create Task
           [GET]    /profile             -> Get User Profile
           [PUT]    /profile             -> Update Profile
           [GET]    /notifications       -> Get Alerts
           [PUT]    /notifications/:id/read -> Mark Read
           [POST]   /auth/forgot-password -> Request Reset
           [POST]   /auth/reset-password  -> Confirm Reset
           [GET]    /leaderboard         -> Attendance Rankings
           [GET]    /feedback            -> Get Feedback (Owner)
           [POST]   /feedback            -> Submit Feedback
        */

        const app = document.getElementById('app');
        const loginPage = document.getElementById('login-page');
        const viewTitle = document.getElementById('current-view-title');
        const todayDate = document.getElementById('today-date');
        const navLinks = document.querySelectorAll('.nav-link[data-view]');
        const views = document.querySelectorAll('.view');
        
        const modal = document.getElementById('app-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalFooter = document.getElementById('modal-footer');
        
        const detailPanel = document.getElementById('member-detail-panel');
        const panelMemberName = document.getElementById('panel-member-name');
        let allMembers = []; // Store members for dropdowns
        let currentDetailMemberId = null; // For document uploads
        let revenueChartInstance = null;
        let attendanceChartInstance = null;
        let calendar = null;
        let staffCalendar = null;
        let allEquipment = []; // Store equipment for logs

        const VIEW_TITLES = {
            'dashboard': 'Dashboard',
            'members': 'Members Management',
            'classes': 'Classes & Schedule',
            'plans': 'Membership Plans',
            'staff': 'Staff Management',
            'billing': 'Billing & Payments',
            'leads': 'Lead Management (CRM)',
            'reports': 'Reports & Analytics',
            'attendance': 'Attendance & Check-in',
            'equipment': 'Equipment & Maintenance',
            'inventory': 'Inventory & POS',
            'settings': 'Settings & Configuration',
            'notifications': 'Notification Center',
            'calendar': 'Calendar',
            'member-portal': 'Member Portal',
            'feedback': 'Member Feedback',
            'staff-schedule': 'Staff Schedule'
        };
        
        // ============ INITIALIZATION ============
        // Catch uncaught errors to help debug wiring failures
        window.addEventListener('error', function (ev) {
            console.error('Window error captured', ev.message, ev.error, ev.filename, ev.lineno, ev.colno);
        });
        window.addEventListener('unhandledrejection', function (ev) {
            console.error('Unhandled promise rejection', ev.reason);
        });
        function initApp() {
            // ============ LOGIN/LOGOUT FLOW (Moved inside initApp) ============
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('Login form submitted');

                    const email = document.getElementById('login-email')?.value || '';
                    const password = document.getElementById('login-password')?.value || '';

                    // Try backend login first
                    try {
                        const res = await fetch(`${API_BASE_URL}/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });

                        if (res.ok) {
                            const body = await res.json();
                            if (body && body.token) {
                                localStorage.setItem('authToken', body.token);
                                localStorage.setItem('isLoggedIn', 'true');
                                localStorage.setItem('userRole', body.role || 'owner');
                                showNotification('Login successful (backend)', 'success', 2000);
                            } else {
                                console.warn('Login response missing token, falling back to demo');
                                localStorage.setItem('isLoggedIn', 'true');
                                showNotification('Logged in (demo fallback)', 'info', 2200);
                            }
                        } else {
                            // Backend returned error (user may not exist if Mongo offline)
                            const err = await res.json().catch(() => ({}));
                            console.warn('Backend login failed', err);
                            localStorage.setItem('isLoggedIn', 'true');
                            showNotification('Logged in (demo fallback) — backend auth unavailable', 'warning', 3000);
                        }
                    } catch (err) {
                        console.warn('Login request failed, using demo fallback', err);
                        localStorage.setItem('isLoggedIn', 'true');
                        showNotification('Logged in (demo fallback) — offline', 'warning', 3000);
                    }

                    // Show app
                    loginPage.classList.add('hidden');
                    app.classList.remove('hidden');
                    // Load API-driven content now that user is logged in (or demo)
                    
                    const role = localStorage.getItem('userRole');
                    if (role === 'member') {
                        initMemberPortal();
                        return;
                    }

                    try {
                        fetchMembers();
                        fetchDashboardStats();
                        fetchClasses();
                        fetchStaff();
                        fetchPlans();
                        fetchInvoices();
                        fetchLeads();
                        fetchEquipment();
                        fetchInventory();
                        fetchAttendance();
                        fetchReports();
                        fetchSettings();
                        fetchTasks();
                        fetchProfile();
                        fetchNotifications();
                        fetchFeedback();
                        initCalendar();
                        initStaffCalendar();
                    } catch (e) { console.warn('Post-login data load failed', e); }

                    // Switch to dashboard
                    setTimeout(() => {
                        switchView('dashboard');
                    }, 100);
                });
            } else {
                console.error('Login form not found');
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userRole');
                    // force a reload to reset state and listeners
                    showNotification('You have been logged out.', 'info', 1200);
                    setTimeout(() => location.reload(), 600);
                });
            }

            // Check if logged in (demo only)
            let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const storedToken = localStorage.getItem('authToken');

            // If there's an auth token but no explicit isLoggedIn flag, clear the token to avoid accidental auto-login
            if (!isLoggedIn && storedToken) {
                console.warn('Found stale authToken without isLoggedIn flag; clearing token');
                localStorage.removeItem('authToken');
            }

            if (isLoggedIn) {
                // If a token exists, validate it with a quick protected call. If invalid, remove token and fall back to demo.
                if (storedToken) {
                    (async () => {
                        try {
                            const resp = await fetch(`${API_BASE_URL}/members`, { headers: { 'Authorization': `Bearer ${storedToken}` } });
                            if (resp.status === 401) {
                                console.warn('Stored token invalid; clearing and using demo mode');
                                localStorage.removeItem('authToken');
                                showNotification('Backend auth expired. Running in demo mode.', 'warning', 2500);
                            } else {
                                // token ok
                            }
                        } catch (err) {
                            console.warn('Token validation request failed; continuing in demo mode', err);
                        } finally {
                            // Show app regardless (demo or real)
                            loginPage.classList.add('hidden');
                            app.classList.remove('hidden');
                        }
                    })();
                } else {
                    loginPage.classList.add('hidden');
                    app.classList.remove('hidden');
                }
            } else {
                loginPage.classList.remove('hidden');
                app.classList.add('hidden');
            }
            // Initialize member selection listeners for bulk actions
            const selectAllCheckbox = document.getElementById('select-all-members');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => toggleSelectAllMembers(e.target));
            }

            // Note: Individual member checkboxes use onclick handlers in HTML for immediate feedback

            // Wire the bulk send and import buttons with fallbacks and logs
            const bulkSendBtn = document.getElementById('bulk-send-sms-btn');
            if (bulkSendBtn) {
                bulkSendBtn.addEventListener('click', () => { console.log('bulk send btn clicked'); handleBulkAction('sendBulkSMS'); });
                console.log('Bulk Send button wired');
            }
            const importBtn = document.getElementById('import-members-btn');
            if (importBtn) {
                importBtn.addEventListener('click', () => { console.log('import btn clicked'); showModal('importMembers'); });
                console.log('Import button wired');
            }

            // Load members and stats only when logged in (demo/backends may require auth)
            const role = localStorage.getItem('userRole');
            if (isLoggedIn && role === 'member') {
                initMemberPortal();
                return;
            }

            if (isLoggedIn) {
                fetchMembers();
                fetchDashboardStats();
                fetchClasses();
                fetchStaff();
                fetchPlans();
                fetchInvoices();
                fetchLeads();
                fetchEquipment();
                fetchInventory();
                fetchAttendance();
                fetchReports();
                fetchSettings();
                fetchTasks();
                fetchProfile();
                fetchNotifications();
                fetchFeedback();
                initCalendar();
                initStaffCalendar();
            }

            updateBulkSendUI();
            initDate();
            // Automatically select the first nav item if none is active
            if (!document.querySelector('.nav-link.active')) {
                 switchView('dashboard');
            }
        }
        
        // ============ MEMBER PORTAL LOGIC ============
        async function initMemberPortal() {
            // Hide sidebar for members
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.style.display = 'none';
            
            // Switch to portal view
            switchView('member-portal');
            
            // Fetch Data
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                
                // 1. Fetch My Attendance
                const attRes = await fetch(`${API_BASE_URL}/attendance`, { headers });
                const attData = await attRes.json().catch(() => []);
                const attBody = document.getElementById('member-attendance-body');
                if (attBody) {
                    attBody.innerHTML = '';
                    if (attData.length === 0) attBody.innerHTML = '<tr><td colspan="3">No records found.</td></tr>';
                    attData.forEach(a => {
                        const date = new Date(a.checkInTime).toLocaleDateString();
                        const time = new Date(a.checkInTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        attBody.innerHTML += `<tr><td>${date}</td><td>${time}</td><td>${a.duration || '-'}</td></tr>`;
                    });
                }

                // 2. Fetch Classes (All classes for now)
                const clsRes = await fetch(`${API_BASE_URL}/classes`, { headers });
                const clsData = await clsRes.json().catch(() => []);
                const clsList = document.getElementById('member-classes-list');
                if (clsList) {
                    clsList.innerHTML = '';
                    if (clsData.length === 0) clsList.innerHTML = '<li>No classes scheduled.</li>';
                    clsData.forEach(c => {
                        clsList.innerHTML += `<li><strong>${c.name}</strong> with ${c.trainer} <br><small>${c.days.join(', ')} at ${c.time}</small></li>`;
                    });
                }

                // 3. Fetch Leaderboard
                fetchLeaderboard();
            } catch (e) {
                console.error('Error loading member portal data', e);
            }
        }

        async function fetchLeaderboard() {
            const tbody = document.getElementById('leaderboard-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/leaderboard`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                if(!data || !data.length) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px;">No data available yet.</td></tr>'; return; }
                
                data.forEach((entry, index) => {
                    let rankIcon = `#${index + 1}`;
                    if (index === 0) rankIcon = '🥇';
                    if (index === 1) rankIcon = '🥈';
                    if (index === 2) rankIcon = '🥉';
                    
                    tbody.innerHTML += `<tr><td><span style="font-size:1.2em;">${rankIcon}</span></td><td>${entry.name || 'Unknown'}</td><td><strong>${entry.count}</strong></td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        // ============ API INTEGRATION ============
        async function fetchMembers() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const response = await fetch(`${API_BASE_URL}/members`, { headers });
                if (!response.ok) {
                    // Non-2xx (likely 401 when backend requires auth)
                    const err = await response.json().catch(() => ({ message: 'Unauthorized' }));
                    console.warn('fetchMembers non-ok response', err);
                    showNotification('Unable to load members: ' + (err.error || err.message || 'Server denied access'), 'warning', 3000);
                    return;
                }

                const payload = await response.json().catch(() => null);
                let members = [];
                if (!payload) {
                    showNotification('Invalid members response from server', 'error', 3000);
                    return;
                }
                // Support raw array or { success:true, data: [...] } shapes
                if (Array.isArray(payload)) members = payload;
                else if (Array.isArray(payload.data)) members = payload.data;
                else if (Array.isArray(payload.members)) members = payload.members;
                else {
                    console.warn('Unexpected members payload', payload);
                    showNotification('No members available', 'info', 2000);
                    return;
                }
                allMembers = members;

                const tbody = document.getElementById('members-table-body');
                if (tbody) {
                    tbody.innerHTML = ''; // Clear existing
                    members.forEach(m => addMemberRow(m));
                }
            } catch (error) {
                console.error('Error fetching members:', error);
                showNotification('Failed to load members from server', 'error');
            }
        }
        
        async function fetchClasses() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const response = await fetch(`${API_BASE_URL}/classes`, { headers });
                if (!response.ok) return;

                const classes = await response.json().catch(() => []);
                const tbody = document.getElementById('classes-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';
                if (classes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-secondary); padding: 20px;">No classes scheduled.</td></tr>';
                    return;
                }

                classes.forEach(c => {
                    const tr = document.createElement('tr');
                    
                    let statusBadge = '<span class="status-badge status-active">Open</span>';
                    if (c.booked >= c.capacity) {
                        statusBadge = '<span class="status-badge status-danger">FULL</span>';
                    } else if (c.booked >= (c.capacity * 0.8)) {
                        statusBadge = '<span class="status-badge status-expiring">Filling Up</span>';
                    }

                    let timeStr = c.time;
                    if (c.days && c.days.length > 0) {
                        timeStr = `${c.days.join(', ')} ${c.time}`;
                    }

                    tr.innerHTML = `<td>${c.name}</td><td>${timeStr}</td><td>${c.trainer}</td><td>${c.booked || 0}/${c.capacity || 20}</td><td>${statusBadge}</td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) { console.error('Error loading classes:', error); }
        }

        async function fetchStaff() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const response = await fetch(`${API_BASE_URL}/staff`, { headers });
                if (!response.ok) return;

                const staffList = await response.json().catch(() => []);
                window.allStaff = staffList; // Store for dropdowns
                const tbody = document.getElementById('staff-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';
                if (staffList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-secondary); padding: 20px;">No staff members found.</td></tr>';
                    return;
                }

                staffList.forEach(s => {
                    const tr = document.createElement('tr');
                    const statusClass = s.status === 'Active' ? 'status-active' : 'status-inactive';
                    
                    tr.innerHTML = `
                        <td>${s.name}<br><small style="color:var(--text-secondary)">${s.email}</small></td>
                        <td>${s.phone || 'N/A'}</td>
                        <td>${s.role}</td>
                        <td><span class="status-badge ${statusClass}">${s.status}</span></td>
                        <td>${s.performance || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showModal('editStaff', '${s.name}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="handleAction('deleteStaff', '${s.id}')" style="margin-left: 4px;">×</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) { console.error('Error loading staff:', error); }
        }

        // ============ NEW FETCH FUNCTIONS ============
        async function fetchPlans() {
            const tbody = document.getElementById('plans-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/plans`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                if(!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No plans found.</td></tr>'; return; }
                data.forEach(p => {
                    tbody.innerHTML += `<tr><td>${p.name}</td><td>${p.duration}</td><td>₹${p.price}</td><td>${p.activeMembers || 0}</td><td>N/A</td><td><button class="btn btn-sm btn-secondary">Edit</button></td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function fetchInvoices() {
            const tbody = document.getElementById('billing-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/invoices`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                if(!data || !data.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No invoices found.</td></tr>'; return; }
                data.forEach(i => {
                    const badge = i.status === 'Paid' ? 'status-paid' : 'status-due';
                    tbody.innerHTML += `<tr><td>${i.id}</td><td>${i.memberName}</td><td>${i.plan}</td><td>₹${i.amount}</td><td>${i.dueDate}</td><td><span class="status-badge ${badge}">${i.status}</span></td><td><button class="btn btn-sm btn-secondary">View</button></td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function fetchLeads() {
            const tbody = document.getElementById('leads-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/leads`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                if(!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No leads found.</td></tr>'; return; }
                data.forEach(l => {
                    tbody.innerHTML += `<tr><td>${l.name}</td><td>${l.phone}</td><td>${l.source}</td><td><span class="status-badge status-new">${l.status}</span></td><td>${l.nextFollowUp || '-'}</td><td><button class="btn btn-sm btn-primary">Log</button></td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function fetchEquipment() {
            const tbody = document.getElementById('equipment-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/equipment`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                if(!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No equipment found.</td></tr>'; return; }
                allEquipment = data; // Store globally
                data.forEach(e => {
                    tbody.innerHTML += `<tr><td>${e.name}</td><td>${e.category}</td><td>${e.purchaseDate}</td><td><span class="status-badge status-active">${e.status}</span></td><td>${e.nextMaintenance}</td><td><button class="btn btn-sm btn-secondary" onclick="showModal('editEquipment', '${e.id}')">Edit</button> <button class="btn btn-sm btn-info" style="margin-left:4px;" onclick="showModal('maintenanceLog', '${e.id}')">Logs</button></td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function fetchInventory() {
            const tbody = document.getElementById('inventory-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/inventory`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                if(!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No products found.</td></tr>'; return; }
                data.forEach(p => {
                    tbody.innerHTML += `<tr><td>${p.name}</td><td>${p.category}</td><td>${p.stock}</td><td>₹${p.price}</td><td>${p.sold}</td><td><button class="btn btn-sm btn-primary">Sell</button></td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function fetchAttendance() {
            const tbody = document.getElementById('attendance-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/attendance`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                if(!data || !data.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No attendance records found.</td></tr>'; return; }
                
                data.forEach(a => {
                    const checkIn = new Date(a.checkInTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    let checkOutDisplay = '-';
                    if(a.status === 'Checked In') {
                        checkOutDisplay = `<button class="btn btn-sm btn-primary" onclick="handleAction('checkout', '${a.id}')">Check Out</button>`;
                    } else if (a.checkOutTime) {
                        checkOutDisplay = new Date(a.checkOutTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                    
                    tbody.innerHTML += `<tr>
                        <td>${checkIn}</td>
                        <td>${a.memberName}</td>
                        <td>${checkOutDisplay}</td>
                        <td>${a.duration || '-'}</td>
                        <td><button class="btn btn-sm btn-secondary">Edit</button></td>
                    </tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function fetchFeedback() {
            const tbody = document.getElementById('feedback-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/feedback`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                if(!data || !data.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px;">No feedback received.</td></tr>'; return; }
                
                data.forEach(f => {
                    const date = new Date(f.date).toLocaleDateString();
                    const typeColor = f.type === 'Complaint' ? 'var(--danger)' : (f.type === 'Praise' ? 'var(--success)' : 'var(--primary)');
                    
                    tbody.innerHTML += `<tr><td>${date}</td><td><span style="color:${typeColor}; font-weight:600;">${f.type}</span></td><td>${f.message}</td><td><span class="status-badge status-active">${f.status}</span></td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function fetchSettings() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const res = await fetch(`${API_BASE_URL}/settings`, { headers });
                if (!res.ok) return;
                const data = await res.json();
                
                if (document.getElementById('set-gym-name')) document.getElementById('set-gym-name').value = data.gymName || '';
                if (document.getElementById('set-gym-email')) document.getElementById('set-gym-email').value = data.email || '';
                if (document.getElementById('set-gym-phone')) document.getElementById('set-gym-phone').value = data.phone || '';
                if (document.getElementById('set-gym-address')) document.getElementById('set-gym-address').value = data.address || '';
                if (document.getElementById('set-gym-color')) document.getElementById('set-gym-color').value = data.primaryColor || '#2563EB';
                if (document.getElementById('set-gym-theme')) document.getElementById('set-gym-theme').value = data.theme || 'light';
                
                // Update sidebar name if available
                if (data.gymName) document.getElementById('gym-name-display').textContent = data.gymName;
            } catch (e) { console.error('Error fetching settings:', e); }
        }

        async function fetchTasks() {
            const list = document.getElementById('dashboard-tasks-list');
            if (!list) return;
            list.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/tasks`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const tasks = await res.json();
                
                if (!tasks || tasks.length === 0) {
                    list.innerHTML = '<li style="color: var(--text-secondary); font-size: 13px;">No pending tasks.</li>';
                    return;
                }

                tasks.forEach(t => {
                    const priorityColor = t.priority === 'High' ? 'var(--danger)' : (t.priority === 'Medium' ? 'var(--warning)' : 'var(--success)');
                    const li = document.createElement('li');
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.innerHTML = `
                        <div><span style="color: ${priorityColor}; font-weight: 600;">•</span> ${t.title} <span style="font-size: 11px; color: var(--text-secondary);">(${t.assignedTo})</span></div>
                        <button class="btn btn-sm btn-secondary" style="padding: 2px 8px; font-size: 10px;" onclick="handleAction('completeTask', '${t.id}')">Done</button>
                    `;
                    list.appendChild(li);
                });
            } catch (e) { console.error('Error fetching tasks:', e); }
        }

        async function fetchProfile() {
            try {
                const res = await fetch(`${API_BASE_URL}/profile`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                if (!res.ok) return;
                const user = await res.json();
                
                // Update Topbar
                if (user.name) document.getElementById('topbar-username').textContent = user.name;
                const avatarEl = document.getElementById('topbar-avatar');
                if (user.avatar) {
                    avatarEl.innerHTML = `<img src="${user.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                } else {
                    avatarEl.innerHTML = user.name ? user.name.charAt(0).toUpperCase() : 'O';
                }

                // Apply Theme from Profile
                if (user.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                
                // Update Personal Settings UI if visible
                const themeSelect = document.getElementById('personal-theme-select');
                if (themeSelect) themeSelect.value = user.theme || 'light';
                
                // Store for modal use
                window.currentUser = user;
            } catch (e) { console.error('Error fetching profile:', e); }
        }

        async function fetchNotifications() {
            const list = document.getElementById('notifications-list');
            if (!list) return;
            list.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE_URL}/notifications`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                const data = await res.json();
                
                if (!data || data.length === 0) {
                    list.innerHTML = '<li style="padding:12px; color:var(--text-secondary);">No new notifications.</li>';
                    return;
                }

                data.forEach(n => {
                    const li = document.createElement('li');
                    li.style.borderLeft = `4px solid var(--${n.type})`;
                    li.style.paddingLeft = '12px';
                    li.style.marginBottom = '12px';
                    li.style.opacity = n.read ? '0.6' : '1';
                    
                    li.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <p style="font-weight: 600; color: var(--${n.type});">${n.title}</p>
                            ${!n.read ? `<button class="btn btn-sm btn-secondary" style="padding:2px 6px; font-size:10px;" onclick="markNotificationRead('${n.id}')">Mark Read</button>` : ''}
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary);">${n.message}</p>
                        <small style="font-size: 10px; color: #9ca3af;">${new Date(n.date).toLocaleString()}</small>
                    `;
                    list.appendChild(li);
                });
            } catch (e) { console.error(e); }
        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;

            // If already initialized, just refetch
            if (calendar) {
                calendar.refetchEvents();
                return;
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                height: 'auto',
                navLinks: true,
                editable: false,
                events: async function(info, successCallback, failureCallback) {
                    try {
                        const token = localStorage.getItem('authToken');
                        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                        
                        // Fetch Data
                        const [classesRes, tasksRes] = await Promise.all([
                            fetch(`${API_BASE_URL}/classes`, { headers }),
                            fetch(`${API_BASE_URL}/tasks`, { headers })
                        ]);
                        
                        const classes = await classesRes.json().catch(() => []);
                        const tasks = await tasksRes.json().catch(() => []);
                        
                        const events = [];
                        const dayMap = { 'Sun': 0, 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5, 'Sat': 6 };

                        // Map Classes (Recurring)
                        if (Array.isArray(classes)) {
                            classes.forEach(c => {
                                let timeParts = (c.time || '').match(/(\d+):(\d+)\s*(AM|PM)/i);
                                if (timeParts) {
                                    let hour = parseInt(timeParts[1]);
                                    let minute = parseInt(timeParts[2]);
                                    if (timeParts[3].toUpperCase() === 'PM' && hour < 12) hour += 12;
                                    if (timeParts[3].toUpperCase() === 'AM' && hour === 12) hour = 0;
                                    
                                    const startTime = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                                    const days = (c.days || []).map(d => dayMap[d]).filter(d => d !== undefined);
                                    
                                    if (days.length) {
                                        events.push({
                                            title: c.name,
                                            startTime: startTime,
                                            daysOfWeek: days,
                                            duration: { minutes: c.duration || 60 },
                                            backgroundColor: 'var(--primary)',
                                            borderColor: 'var(--primary)',
                                            extendedProps: { type: 'class', trainer: c.trainer }
                                        });
                                    }
                                }
                            });
                        }

                        // Map Tasks (One-time)
                        if (Array.isArray(tasks)) {
                            tasks.forEach(t => {
                                if (t.dueDate && t.status !== 'Completed') {
                                    events.push({
                                        title: `Task: ${t.title}`,
                                        start: t.dueDate,
                                        allDay: true,
                                        backgroundColor: t.priority === 'High' ? 'var(--danger)' : 'var(--warning)',
                                        borderColor: 'transparent',
                                        extendedProps: { type: 'task' }
                                    });
                                }
                            });
                        }
                        
                        successCallback(events);
                    } catch (e) {
                        console.error('Calendar fetch error', e);
                        failureCallback(e);
                    }
                },
                eventClick: function(info) {
                    const p = info.event.extendedProps;
                    if (p.type === 'class') {
                        alert(`Class: ${info.event.title}\nTrainer: ${p.trainer}\nTime: ${info.event.start ? info.event.start.toLocaleTimeString() : ''}`);
                    } else {
                        alert(`Task: ${info.event.title}\nDue: ${info.event.startStr}`);
                    }
                }
            });
            calendar.render();
        }

        function initStaffCalendar() {
            const calendarEl = document.getElementById('staff-calendar');
            if (!calendarEl) return;

            if (staffCalendar) {
                staffCalendar.refetchEvents();
                return;
            }

            staffCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                height: 'auto',
                navLinks: true,
                editable: false,
                events: async function(info, successCallback, failureCallback) {
                    try {
                        const token = localStorage.getItem('authToken');
                        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                        
                        const res = await fetch(`${API_BASE_URL}/shifts`, { headers });
                        const shifts = await res.json().catch(() => []);
                        
                        const events = shifts.map(s => ({
                            title: `${s.staffName} (${s.role})`,
                            start: s.start,
                            end: s.end,
                            backgroundColor: 'var(--info)',
                            borderColor: 'var(--info)',
                            extendedProps: { type: 'shift' }
                        }));
                        
                        successCallback(events);
                    } catch (e) {
                        console.error('Staff calendar fetch error', e);
                        failureCallback(e);
                    }
                },
                eventClick: function(info) {
                    const start = info.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const end = info.event.end ? info.event.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '?';
                    alert(`Shift: ${info.event.title}\n${start} - ${end}`);
                }
            });
            staffCalendar.render();
        }

        async function markNotificationRead(id) {
            try {
                await fetch(`${API_BASE_URL}/notifications/${id}/read`, { method: 'PUT', headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
                fetchNotifications();
            } catch(e) { console.error(e); }
        }

        async function saveSettings() {
            const payload = {
                gymName: document.getElementById('set-gym-name').value,
                email: document.getElementById('set-gym-email').value,
                phone: document.getElementById('set-gym-phone').value,
                address: document.getElementById('set-gym-address').value,
                primaryColor: document.getElementById('set-gym-color').value,
                theme: document.getElementById('set-gym-theme').value
            };
            
            try {
                const token = localStorage.getItem('authToken');
                const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
                await fetch(`${API_BASE_URL}/settings`, { method: 'POST', headers, body: JSON.stringify(payload) });
                showNotification('Settings saved successfully!', 'success');
                fetchSettings(); // Refresh UI
            } catch (e) {
                showNotification('Error saving settings', 'error');
            }
        }

        async function fetchReports() {
            // Only fetch if the reports view is active or about to be active, 
            // but for simplicity in this prototype we fetch on load to ensure data is ready.
            
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                // 1. Fetch Revenue Data
                const revRes = await fetch(`${API_BASE_URL}/reports/revenue`, { headers });
                const revData = await revRes.json().catch(() => ({}));
                
                // 2. Fetch Attendance Data
                const attRes = await fetch(`${API_BASE_URL}/reports/attendance`, { headers });
                const attData = await attRes.json().catch(() => ({}));

                renderCharts(revData, attData);
            } catch (e) { console.error('Error fetching reports:', e); }
        }

        function renderCharts(revenueData, attendanceData) {
            // Revenue Chart
            const revCtx = document.getElementById('revenueChart');
            if (revCtx) {
                if (revenueChartInstance) revenueChartInstance.destroy();
                revenueChartInstance = new Chart(revCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(revenueData),
                        datasets: [{
                            label: 'Revenue (₹)',
                            data: Object.values(revenueData),
                            backgroundColor: 'rgba(37, 99, 235, 0.6)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }

            // Attendance Chart
            const attCtx = document.getElementById('attendanceChart');
            if (attCtx) {
                // Sort dates
                const sortedDates = Object.keys(attendanceData).sort();
                const sortedCounts = sortedDates.map(d => attendanceData[d]);

                if (attendanceChartInstance) attendanceChartInstance.destroy();
                attendanceChartInstance = new Chart(attCtx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Daily Check-ins',
                            data: sortedCounts,
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }
        }

        async function fetchDashboardStats() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const response = await fetch(`${API_BASE_URL}/dashboard-stats`, { headers });
                if (!response.ok) {
                    console.warn('fetchDashboardStats non-ok');
                    return;
                }
                const stats = await response.json().catch(() => null);
                if (!stats) return;
                const activeEl = document.getElementById('stat-active-members');
                const revenueEl = document.getElementById('stat-revenue');
                if (activeEl && (typeof stats.activeMembers === 'number' || stats.activeMembers)) activeEl.innerHTML = `${stats.activeMembers} <span style="font-size: 16px; color: var(--success);">↑ 15%</span>`;
                if (revenueEl && (typeof stats.revenue === 'number' || stats.revenue)) revenueEl.innerHTML = `₹${Number(stats.revenue).toLocaleString()} <span style="font-size: 16px; color: var(--success);">↑ 8%</span>`;
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        function initDate() {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            const today = new Date().toLocaleDateString('en-IN', options);
            todayDate.textContent = today;
        }
        
        // ============ NAVIGATION FLOW (Re-enabled) ============
        function switchView(viewName) {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');

            navLinks.forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-link[data-view="${viewName}"]`);
            if (activeLink) activeLink.classList.add('active');

            viewTitle.textContent = VIEW_TITLES[viewName] || 'GymFlow';
            closeDetailPanel();

            // Refresh calendar if visible to ensure correct sizing
            if (viewName === 'calendar' && calendar) {
                setTimeout(() => calendar.render(), 50);
            }
            if (viewName === 'staff-schedule' && staffCalendar) {
                setTimeout(() => staffCalendar.render(), 50);
            }
        }

        // Navigation link click handling is implemented via inline onclick handlers in markup
        // Avoid adding duplicate programmatic listeners to prevent double-triggering

        // ============ SETTINGS TAB SWITCHING (Re-enabled) ============
        function switchSettingsTab(tabName) {
            document.querySelectorAll('#view-settings .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#view-settings .settings-panel').forEach(p => p.classList.remove('active'));

            document.querySelector(`#view-settings .tab[data-settings-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`settings-${tabName}`).classList.add('active');
        }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
        }

        // ============ MODAL FLOW (Re-enabled) ============
        function showModal(type, item = null) {
            console.log('showModal called for', type, item);
            modalTitle.textContent = getModalTitle(type, item);
            modalBody.innerHTML = getModalContent(type, item);
            modalFooter.innerHTML = getModalFooter(type, item);

            modal.classList.add('open');
            // Mark modal visible for assistive tech and focus content
            modal.setAttribute('aria-hidden', 'false');
            const modalContentEl = modal.querySelector('.modal-content');
            if (modalContentEl && typeof modalContentEl.focus === 'function') modalContentEl.focus();
            // If this is an import modal, wire up inline buttons and preview handling
            if (type === 'importMembers') {
                const excelInput = document.getElementById('import-members-excel');
                const imagesInput = document.getElementById('import-members-images');
                const chooseFileBtn = modalBody.querySelector('#import-choose-file-btn');
                const uploadImagesBtn = modalBody.querySelector('#import-upload-images-btn');
                const previewEl = modalBody.querySelector('#import-preview');
                const fileNameSpan = modalBody.querySelector('#import-file-name');
                const imagesCountSpan = modalBody.querySelector('#import-images-count');
                if (chooseFileBtn && excelInput) {
                    chooseFileBtn.addEventListener('click', (e) => { e.preventDefault(); excelInput.click(); });
                }
                if (uploadImagesBtn && imagesInput) {
                    uploadImagesBtn.addEventListener('click', (e) => { e.preventDefault(); imagesInput.click(); });
                }
                if (excelInput) {
                    excelInput.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) { fileNameSpan.textContent = ''; previewEl.innerHTML = '<p>No file selected.</p>'; return; }
                        fileNameSpan.textContent = file.name;
                        try {
                            const rows = await parseExcelOrCSV(file);
                            previewEl.innerHTML = '<table class="table"><thead><tr><th>Name</th><th>Phone</th><th>Plan</th></tr></thead><tbody>' + rows.slice(0, 10).map(r => `<tr><td>${(r.name||r.firstName||r.lastName||'').toString()}</td><td>${r.phone||''}</td><td>${r.plan||''}</td></tr>`).join('') + '</tbody></table>';
                        } catch (err) { console.error('Preview parse error', err); previewEl.innerHTML = '<p>Error previewing file. See console.</p>'; }
                    };
                }
                if (imagesInput) {
                    imagesInput.onchange = (e) => {
                        const files = e.target.files || [];
                        imagesCountSpan.textContent = files.length ? `${files.length} images` : '';
                    };
                }
            }
            // For sendBulkSMS modal, add friendly notification and ensure confirm works
            if (type === 'sendBulkSMS') {
                const confirmBtn = modalFooter.querySelector('#send-bulk-sms-confirm');
                if (confirmBtn) confirmBtn.addEventListener('click', (e) => { e.preventDefault(); handleAction('sendBulkSMS'); });
            }
        }

        function closeModal() {
            console.log('closeModal called');
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            modalBody.innerHTML = '';
            // Reset focus to the main app area (if available)
            const appRoot = document.getElementById('app');
            if (appRoot && typeof appRoot.focus === 'function') appRoot.focus();
        }
        
        // Close modal on escape key press
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('open')) {
                closeModal();
            }
        });

        // Close modal when clicking outside the content
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // ============ DETAIL PANEL FLOW (Re-enabled) ============
        function openDetailPanel(type, item = null) {
            if (type === 'member') {
                let member = item;
                // Handle legacy calls or string lookups
                if (typeof item === 'string') {
                    member = allMembers.find(m => m.name === item) || { name: item, id: 'unknown' };
                }
                
                currentDetailMemberId = member.id;
                panelMemberName.textContent = member.name;
                
                const content = document.getElementById('panel-member-content');
                const statusClass = member.status ? 'status-' + member.status.toLowerCase() : 'status-active';
                
                // Build Documents List
                let docsHtml = '<p style="font-size:13px; color:var(--text-secondary);">No documents uploaded.</p>';
                if (member.documents && member.documents.length > 0) {
                    docsHtml = member.documents.map(d => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;">
                            <a href="${d.url}" target="_blank" style="text-decoration:none; color:var(--primary); font-weight:500;">📄 ${d.name}</a>
                            <small style="color:#999;">${new Date(d.date).toLocaleDateString()}</small>
                        </div>
                    `).join('');
                }

                content.innerHTML = `
                    <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px;">
                        <div class="owner-avatar" style="width: 60px; height: 60px; font-size: 20px;">${member.name.charAt(0)}</div>
                        <div>
                            <p style="font-size: 16px; font-weight: 700;">${member.name}</p>
                            <p class="status-badge ${statusClass}">${member.status || 'Active'}</p>
                        </div>
                    </div>
                    
                    <h4 class="panel-section-title">PERSONAL INFORMATION</h4>
                    <p><strong>Phone:</strong> ${member.phone || 'N/A'} <button class="btn btn-secondary btn-sm" onclick="alert('Calling...')">Call</button></p>
                    <p><strong>Email:</strong> ${member.email || 'N/A'} <button class="btn btn-secondary btn-sm" onclick="alert('Emailing...')">Email</button></p>
                    
                    <h4 class="panel-section-title">MEMBERSHIP STATUS</h4>
                    <p><strong>Current Plan:</strong> ${member.plan || 'N/A'}</p>
                    <p><strong>Expiry Date:</strong> ${member.expiry || 'N/A'}</p>
                    
                    <h4 class="panel-section-title">DOCUMENTS</h4>
                    <div id="member-documents-list" style="margin-bottom:12px;">${docsHtml}</div>
                    <input type="file" id="doc-upload-input" style="display: none;" onchange="handleDocUpload(this)">
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('doc-upload-input').click()">+ Upload Document</button>

                    <h4 class="panel-section-title">MEMBER ACTIONS</h4>
                    <div class="quick-actions">
                        <button class="btn btn-primary btn-sm" onclick="showModal('editMember', '${member.name}')">Edit</button>
                        <button class="btn btn-primary btn-sm" onclick="showModal('renewMember', '${member.name}')">Renew</button>
                        <button class="btn btn-secondary btn-sm" onclick="showModal('freezeMember', '${member.name}')">Freeze</button>
                        <button class="btn btn-danger btn-sm" onclick="showModal('deleteMember', '${member.id}')">Delete</button>
                    </div>
                `;
            }
            
            detailPanel.classList.add('open');
            detailPanel.setAttribute('aria-hidden', 'false');
            if (typeof detailPanel.focus === 'function') detailPanel.focus();
        }

        function closeDetailPanel() {
            detailPanel.classList.remove('open');
            detailPanel.setAttribute('aria-hidden', 'true');
        }
        
        // Add event listener to close button on panel
        const panelCloseBtn = document.querySelector('#member-detail-panel .close-modal');
        if (panelCloseBtn) panelCloseBtn.addEventListener('click', closeDetailPanel);

        // ============ DOCUMENT UPLOAD LOGIC ============
        async function handleDocUpload(input) {
            const file = input.files[0];
            if (!file || !currentDetailMemberId) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const payload = {
                    name: file.name,
                    url: e.target.result // Base64 string
                };

                try {
                    const res = await fetch(`${API_BASE_URL}/members/${currentDetailMemberId}/documents`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken')}` },
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        showNotification('Document uploaded successfully', 'success');
                        fetchMembers().then(() => {
                            // Re-open panel to refresh data (simplified)
                            const updatedMember = allMembers.find(m => m.id === currentDetailMemberId);
                            if (updatedMember) openDetailPanel('member', updatedMember);
                        });
                    } else throw new Error('Upload failed');
                } catch (err) {
                    showNotification('Error uploading document', 'error');
                    console.error(err);
                }
            };
            reader.readAsDataURL(file);
        }

        // ============ MODAL CONTENT STUBS (Implementations of spec sections) ============

        function getModalTitle(type, item) {
            switch (type) {
                case 'addMember': return 'New Member';
                case 'editMember': return `Edit Member: ${item}`;
                case 'renewMember': return `Renew Membership for ${item}`;
                case 'freezeMember': return `Freeze Membership`;
                case 'sendMessage': return `Send Message to ${item}`;
                case 'addStaff': return 'New Staff Member';
                case 'createClass': return 'New Class';
                case 'recordPayment': return `Record Payment for ${item || 'Invoice#'}`;
                case 'openPOS': return 'POS - Quick Sale';
                case 'addPlan': return 'New Membership Plan';
                case 'scheduleMaintenance': return `Schedule Maintenance - ${item}`;
                case 'addLead': return 'New Lead';
                case 'campaignBuilder': return 'Campaign Builder';
                case 'viewLeadDetail': return `${item} - Lead Detail`;
                case 'convertToMember': return `Convert Lead ${item} to Member`;
                case 'razorpaySettings': return `Razorpay Integration Setup`;
                case 'importMembers': return `Import Members (Excel / CSV)`;
                case 'checkin': return 'Member Check-in';
                case 'addTask': return 'Create New Task';
                case 'profile': return 'Edit Profile';
                case 'forgotPassword': return 'Reset Password';
                case 'resetPassword': return 'Set New Password';
                case 'submitFeedback': return 'Submit Feedback';
                case 'assignShift': return 'Assign Staff Shift';
                case 'maintenanceLog': return 'Maintenance Log';
                default: return 'GymFlow Action';
            }
        }

        function getModalContent(type, item) {
            switch (type) {
                case 'addMember':
                    return `
                        <div class="form-group"><label>First Name *</label><input type="text" id="new-mem-firstname" class="form-control" placeholder="John" required></div>
                        <div class="form-group"><label>Last Name *</label><input type="text" id="new-mem-lastname" class="form-control" placeholder="Doe" required></div>
                        <div class="form-group"><label>Email *</label><input type="email" id="new-mem-email" class="form-control" placeholder="john@email.com" required></div>
                        <div class="form-group"><label>Phone Number *</label><input type="text" id="new-mem-phone" class="form-control" placeholder="98765-43210" required></div>
                        <div class="form-group"><label>Date of Birth</label><input type="date" id="new-mem-dob" class="form-control"></div>
                        <div class="form-group"><label>Membership Plan *</label><select id="new-mem-plan" class="form-control" required><option>12-Month Premium (₹2,999)</option><option>6-Month Standard (₹1,999)</option><option>3-Month Basic (₹1,299)</option></select></div>
                        <div class="form-group"><label>Start Date *</label><input type="date" id="new-mem-start" value="2025-12-11" class="form-control" required></div>
                        <h4 style="margin-top: 24px; font-weight: 700;">PAYMENT DETAILS</h4>
                        <div class="form-group"><label>Amount Due</label><input type="text" value="₹2,999" disabled class="form-control" style="background: rgba(0,0,0,0.05);"></div>
                        <div class="form-group"><label><input type="checkbox" checked> Enable Auto-Renewal</label></div>
                    `;
                
                case 'editMember':
                    return `
                        <div class="form-group"><label>First Name *</label><input type="text" class="form-control" value="John" required></div>
                        <div class="form-group"><label>Last Name *</label><input type="text" class="form-control" value="Doe" required></div>
                        <div class="form-group"><label>Email</label><input type="email" class="form-control" value="john@email.com"></div>
                        <div class="form-group"><label>Phone Number</label><input type="text" class="form-control" value="98765-43210"></div>
                        <div class="form-group"><label>Membership Status</label><select class="form-control"><option>Active</option><option>Frozen</option><option>Cancelled</option></select></div>
                        <div class="form-group"><label>Current Plan</label><input type="text" disabled class="form-control" value="12-Month Premium"></div>
                    `;
                
                case 'renewMember':
                    return `
                        <p style="margin-bottom: 16px; padding: 12px; background: rgba(16,185,129,0.1); border-radius: 8px;">
                            <strong>Member:</strong> ${item || 'John Doe'} | <strong>Current Plan:</strong> 12-Month Premium<br>
                            <strong>Expiry:</strong> 15-Dec-2025 (4 days remaining)
                        </p>
                        <div class="form-group"><label>Renew Plan *</label><select class="form-control"><option>12-Month Premium (₹2,999)</option><option>6-Month Standard (₹1,999)</option></select></div>
                        <div class="form-group"><label>Renewal Price</label><input type="text" value="₹2,999" disabled class="form-control" style="background: rgba(0,0,0,0.05);"></div>
                        <div class="form-group"><label>Payment Method *</label><select class="form-control"><option>Card</option><option>Bank Transfer</option><option>Cash</option><option>UPI</option></select></div>
                        <div class="form-group"><label><input type="checkbox" checked> Enable Auto-Renewal for future</label></div>
                    `;

                case 'freezeMember':
                    return `
                        <p style="margin-bottom: 20px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px;">
                            <strong>Freeze Membership</strong><br>
                            Member <strong>${item}</strong> will not be charged, but access will be suspended.
                        </p>
                        <div class="form-group"><label>Freeze Duration (Months) *</label><input type="number" value="1" min="1" max="12" class="form-control" required></div>
                        <div class="form-group"><label>Reason for Freeze</label>
                            <select class="form-control">
                                <option>Personal (Travel/Work)</option>
                                <option>Injury/Medical</option>
                                <option>Financial</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group"><label><input type="checkbox"> Notify member via SMS</label></div>
                    `;

                case 'sendMessage':
                    return `
                        <p style="margin-bottom: 16px; padding: 12px; background: rgba(37,99,235,0.1); border-radius: 8px;">
                            <strong>Send Message to ${item || 'Member'}</strong>
                        </p>
                        <div class="form-group"><label>Message Type *</label><select class="form-control"><option>SMS</option><option>Email</option><option>WhatsApp</option></select></div>
                        <div class="form-group"><label>Subject (Email)</label><input type="text" class="form-control" placeholder="Your membership renewal"></div>
                        <div class="form-group"><label>Message *</label><textarea class="form-control" rows="4" placeholder="Hi {name}..." required></textarea></div>
                        <div class="form-group"><label><input type="checkbox" checked> Use template</label></div>
                    `;
                    
                case 'createClass':
                    return `
                        <div class="form-group"><label>Class Name *</label><input type="text" class="form-control" placeholder="Yoga / CrossFit / Zumba" required></div>
                        <div class="form-group"><label>Description</label><textarea class="form-control" rows="2" placeholder="Class details..."></textarea></div>
                        <div class="form-group"><label>Days of Week *</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <label><input type="checkbox" checked> Mon</label>
                                <label><input type="checkbox"> Tue</label>
                                <label><input type="checkbox" checked> Wed</label>
                                <label><input type="checkbox"> Thu</label>
                                <label><input type="checkbox" checked> Fri</label>
                                <label><input type="checkbox"> Sat</label>
                                <label><input type="checkbox"> Sun</label>
                            </div>
                        </div>
                        <div class="form-group"><label>Start Time *</label><input type="time" value="06:00" class="form-control" required></div>
                        <div class="form-group"><label>Duration (minutes) *</label><input type="number" value="60" min="15" class="form-control" required></div>
                        <div class="form-group"><label>Assigned Trainer *</label><select class="form-control" required><option>Rahul Kumar</option><option>Maria Silva</option><option>Priya Sharma</option></select></div>
                        <div class="form-group"><label>Class Capacity *</label><input type="number" value="20" min="5" max="50" class="form-control" required></div>
                    `;

                case 'addEquipment':
                    return `
                        <div class="form-group"><label>Equipment Name *</label><input type="text" class="form-control" placeholder="Treadmill" required></div>
                        <div class="form-group"><label>Category *</label><select class="form-control" required><option>Cardio</option><option>Strength</option><option>Functional</option></select></div>
                        <div class="form-group"><label>Quantity</label><input type="number" value="1" min="1" class="form-control"></div>
                        <div class="form-group"><label>Cost (₹)</label><input type="number" value="50000" class="form-control"></div>
                        <div class="form-group"><label>Purchase Date</label><input type="date" class="form-control"></div>
                        <div class="form-group"><label>Warranty (Months)</label><input type="number" value="24" class="form-control"></div>
                    `;

                case 'recordPayment':
                     return `
                        <div class="form-group"><label>Invoice / Member *</label><select class="form-control" required><option>INV-003 - Mike Singh - ₹2,999 (Overdue)</option><option>INV-002 - Sarah Khan - ₹1,999 (Due)</option></select></div>
                        <div class="form-group"><label>Amount Due</label><input type="text" value="₹2,999" disabled class="form-control" style="background: rgba(0,0,0,0.05);"></div>
                        <div class="form-group"><label>Amount Paid *</label><input type="number" value="2999" class="form-control" required></div>
                        <div class="form-group"><label>Payment Method *</label>
                            <select class="form-control" required>
                                <option>Bank Transfer</option>
                                <option>Card</option>
                                <option>Cash</option>
                                <option>UPI</option>
                                <option>Cheque</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Payment Date</label><input type="date" value="2025-12-11" class="form-control"></div>
                        <div class="form-group"><label><input type="checkbox" checked> Send receipt to member</label></div>
                        <div class="form-group"><label>Notes</label><textarea class="form-control" rows="2" placeholder="Payment notes..."></textarea></div>
                    `;

                case 'addStaff':
                    return `
                        <div class="form-group"><label>Email/Username *</label><input type="email" id="new-staff-email" class="form-control" placeholder="trainer@gym.com" required></div>
                        <div class="form-group"><label>Full Name *</label><input type="text" id="new-staff-name" class="form-control" placeholder="Rahul Kumar" required></div>
                        <div class="form-group"><label>Role *</label><select id="new-staff-role" class="form-control" required><option>Manager</option><option>Trainer</option><option>Receptionist</option></select></div>
                        <div class="form-group"><label>Phone</label><input type="text" id="new-staff-phone" class="form-control" placeholder="9876543210"></div>
                        <div class="form-group"><label>Specialization</label><input type="text" class="form-control" placeholder="Strength Training, CrossFit"></div>
                        <div class="form-group"><label>Certifications</label><textarea class="form-control" rows="2" placeholder="ACE, NASM, etc..."></textarea></div>
                    `;

                case 'sendBulkSMS':
                    {
                        const membersArr = Array.from(selectedMembers || []);
                        const recipientNames = membersArr.map(id => {
                            const row = document.querySelector(`tr[data-member-id="${id}"]`);
                            return row ? (row.querySelector('td:nth-child(2)')?.innerText || id) : id;
                        }).join(', ');
                        return `
                        <p style="margin-bottom: 16px; padding: 12px; background: rgba(37,99,235,0.1); border-radius: 8px;">
                            <strong>Send SMS to Multiple Members</strong><br>
                            Selected: ${membersArr.length} Member(s)
                        </p>
                        <p style="margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">Recipients: ${recipientNames || 'None'}</p>
                        <div class="form-group"><label>Message Template *</label>
                            <select class="form-control" required>
                                <option>Renewal Reminder</option>
                                <option>Class Attendance</option>
                                <option>Special Offer</option>
                                <option>Custom Message</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Message Preview</label>
                            <textarea class="form-control" rows="3" readonly>Hi {name}, Your membership expires in 7 days. Renew now & get 20% off! Reply RENEW</textarea>
                        </div>
                        <div class="form-group"><label>Schedule Send</label>
                            <select class="form-control">
                                <option selected>Send Now</option>
                                <option>Schedule for Tomorrow 9 AM</option>
                                <option>Schedule for Weekend</option>
                            </select>
                        </div>
                    `;
                    }

                case 'openPOS':
                    return `
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                            <div>
                                <h4 style="margin-bottom: 12px; font-weight: 700;">CART (9.3)</h4>
                                <table class="table">
                                    <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                                    <tbody>
                                        <tr><td>Protein Powder</td><td>2</td><td>₹799</td><td>₹1,598</td></tr>
                                        <tr><td>Yoga Mat</td><td>1</td><td>₹399</td><td>₹399</td></tr>
                                    </tbody>
                                </table>
                                <button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="alert('Adding item to cart...')">+ Add Item</button>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 12px; font-weight: 700;">SUMMARY</h4>
                                <p><strong>Subtotal:</strong> ₹1,997</p>
                                <p><strong>Discount:</strong> -₹0</p>
                                <p><strong>GST (18%):</strong> ₹359</p>
                                <p style="font-size: 18px; font-weight: 700; color: var(--primary); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1);">TOTAL: ₹2,356</p>
                                <h4 style="margin-top: 16px; margin-bottom: 8px;">PAYMENT METHOD</h4>
                                <select class="form-control" style="margin-bottom: 12px;"><option>Cash</option><option>Card</option><option>UPI</option></select>
                                <h4 style="margin-bottom: 8px;">MEMBER (Optional)</h4>
                                <input type="text" placeholder="Member Name (for discount)" class="form-control">
                            </div>
                        </div>
                    `;
                
                case 'scheduleMaintenance':
                    return `
                        <div class="form-group"><label>Equipment</label><input type="text" value="${item}" disabled class="form-control" style="background: rgba(0,0,0,0.05);"></div>
                        <div class="form-group"><label>Service Type *</label><select class="form-control" required><option>General Service</option><option>Repair (Belt)</option><option>Replacement</option><option>Inspection</option></select></div>
                        <div class="form-group"><label>Scheduled Date *</label><input type="date" value="2025-12-15" class="form-control" required></div>
                        <div class="form-group"><label>Expected Cost (₹)</label><input type="number" value="1500" class="form-control"></div>
                        <div class="form-group"><label>Vendor/Technician</label><input type="text" value="Life Fitness Service Center" class="form-control"></div>
                        <div class="form-group"><label><input type="checkbox" checked> Mark equipment unavailable during maintenance</label></div>
                        <div class="form-group"><label><input type="checkbox" checked> Notify all trainers</label></div>
                    `;
                    
                case 'viewLeadDetail':
                     return `
                        <p style="margin-bottom: 12px; padding: 12px; background: rgba(37,99,235,0.1); border-radius: 8px;">
                            <strong>Source:</strong> Google Search | <strong>Added:</strong> 9-Dec-2025<br>
                            <strong style="color: var(--danger);">Next Follow-up Due: TODAY (URGENT)</strong>
                        </p>
                        
                        <h4 class="panel-section-title">INTERACTION HISTORY</h4>
                        <p>• 9-Dec: Added via Google Search</p>
                        <p>• 10-Dec: SMS sent - No response</p>
                        <p>• Last contact: None</p>
                        
                        <h4 class="panel-section-title">LEAD QUALIFICATION</h4>
                        <p><strong>Interest:</strong> Strength training, weight loss</p>
                        <p><strong>Preferred Plan:</strong> 6-Month | <strong>Lead Score:</strong> 7.5/10 (Good)</p>
                        <p><strong>Budget:</strong> ₹1,500-2,000</p>
                        
                        <h4 class="panel-section-title">ACTIONS</h4>
                        <div class="quick-actions" style="margin-top: 12px;">
                            <button class="btn btn-primary btn-sm" onclick="showModal('logInteraction', '${item}')">Log Contact</button>
                            <button class="btn btn-success btn-sm" onclick="showModal('convertToMember', '${item}')">Convert to Member</button>
                        </div>
                    `;
                    
                case 'campaignBuilder':
                     return `
                        <h4 style="margin-bottom: 12px;">TARGET AUDIENCE (10.3)</h4>
                        <div class="form-group"><label>Filter</label>
                            <select class="form-control">
                                <option>Status: New & Contacted</option>
                                <option>Expiring Members (7 days)</option>
                                <option>High-Value Leads</option>
                            </select>
                            <p style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">Matching Leads: 12 (New) / 5 (Expiring Members)</p>
                        </div>
                        <h4 style="margin-top: 24px; margin-bottom: 12px;">CAMPAIGN DETAILS</h4>
                         <div class="form-group"><label>Message Type</label><select class="form-control"><option>SMS</option><option>Email</option><option>WhatsApp</option></select></div>
                         <div class="form-group"><label>Message Preview</label>
                            <textarea class="form-control" rows="3">Hi {name}, Start 2025 fit! Join our gym with ₹500 off. Call 080-XXXX-XXXX</textarea>
                         </div>
                        <div class="form-group"><label><input type="checkbox"> Track conversions from this campaign</label></div>
                    `;
                    
                case 'razorpaySettings':
                    return `
                        <p style="margin-bottom: 16px; padding: 12px; background: rgba(16,185,129,0.1); border-radius: 8px;">
                            <strong>Razorpay Connected</strong> | Status: Active<br>
                            Last sync: 5 min ago | Fees: 2%
                        </p>
                        <div class="form-group"><label>Key ID</label><input type="text" value="rzp_live_XXXXXXXXXXXX" class="form-control" disabled></div>
                        <div class="form-group"><label>Webhook Status</label><input type="text" value="Active" disabled class="form-control" style="background: rgba(16,185,129,0.1);"></div>
                        <h4 style="margin-top: 24px; margin-bottom: 12px;">FEATURES</h4>
                        <div class="form-group"><label><input type="checkbox" checked disabled> Recurring Payments</label></div>
                        <div class="form-group"><label><input type="checkbox" checked disabled> Webhooks (Real-time)</label></div>
                        <div class="form-group"><label><input type="checkbox" checked disabled> Refunds</label></div>
                    `;

                case 'importMembers':
                    return `
                        <p style="margin-bottom: 12px; font-size: 13px; color: var(--text-secondary);">Upload an Excel (.xlsx/.xls) or CSV file containing member details. Add images (optional) to link avatars — filename or phone number mapping supported.</p>
                        <div class="form-group"><label>Excel / CSV File</label>
                            <button id="import-choose-file-btn" class="btn btn-secondary" onclick="document.getElementById('import-members-excel').click()">Choose File</button>
                            <span id="import-file-name" style="margin-left: 8px; font-size: 13px; color: var(--text-secondary);"></span>
                        </div>
                        <div class="form-group"><label>Member Images (optional)</label>
                            <button id="import-upload-images-btn" class="btn btn-secondary" onclick="document.getElementById('import-members-images').click()">Upload Images</button>
                            <span id="import-images-count" style="margin-left: 8px; font-size: 13px; color: var(--text-secondary);"></span>
                        </div>
                        <div id="import-preview" style="margin-top: 12px; max-height: 240px; overflow:auto;">
                            <!-- Preview list will populate here after file selection -->
                        </div>
                    `;

                case 'checkin':
                    const options = allMembers.map(m => `<option value="${m.id}|${m.name}">${m.name}</option>`).join('');
                    return `
                        <div class="form-group"><label>Select Member *</label>
                            <select id="checkin-member-select" class="form-control" required>
                                <option value="">-- Choose Member --</option>
                                ${options}
                            </select>
                        </div>
                        <div class="form-group"><label>Time</label><input type="text" value="Now" disabled class="form-control"></div>
                    `;

                case 'addTask':
                    return `
                        <div class="form-group"><label>Task Title *</label><input type="text" id="new-task-title" class="form-control" placeholder="e.g., Call overdue members" required></div>
                        <div class="form-group"><label>Assigned To</label><select id="new-task-assign" class="form-control"><option>Owner</option><option>Manager</option><option>Receptionist</option></select></div>
                        <div class="form-group"><label>Priority</label><select id="new-task-priority" class="form-control"><option>High</option><option selected>Medium</option><option>Low</option></select></div>
                        <div class="form-group"><label>Due Date</label><input type="date" id="new-task-date" class="form-control"></div>
                    `;

                case 'profile':
                    const user = window.currentUser || { name: 'Owner', email: 'owner@gym.com' };
                    return `
                        <div class="form-group"><label>Full Name</label><input type="text" id="profile-name" class="form-control" value="${user.name || ''}"></div>
                        <div class="form-group"><label>Email</label><input type="email" class="form-control" value="${user.email || ''}" disabled style="background: rgba(0,0,0,0.05);"></div>
                        <div class="form-group"><label>New Password</label><input type="password" id="profile-pass" class="form-control" placeholder="Leave blank to keep current"></div>
                        <div class="form-group"><label>Avatar URL</label><input type="text" id="profile-avatar" class="form-control" value="${user.avatar || ''}" placeholder="https://..."></div>
                        <div class="form-group"><label>Or Upload Avatar</label><input type="file" id="profile-avatar-file" class="form-control" accept="image/*"></div>
                    `;

                case 'forgotPassword':
                    return `<div class="form-group"><label>Enter your email address</label><input type="email" id="forgot-email" class="form-control" placeholder="name@example.com"></div><p style="font-size:12px; color:var(--text-secondary);">We will send a reset link to your email.</p>`;

                case 'resetPassword':
                    return `<div class="form-group"><label>New Password</label><input type="password" id="reset-new-pass" class="form-control" placeholder="••••••••"></div>
                            <div class="form-group"><label>Confirm Password</label><input type="password" id="reset-confirm-pass" class="form-control" placeholder="••••••••"></div>
                            <input type="hidden" id="reset-token" value="${item}">`;

                case 'submitFeedback':
                    return `
                        <div class="form-group"><label>Feedback Type</label><select id="fb-type" class="form-control"><option>Suggestion</option><option>Complaint</option><option>Praise</option><option>Other</option></select></div>
                        <div class="form-group"><label>Message</label><textarea id="fb-message" class="form-control" rows="4" placeholder="Your feedback is anonymous..."></textarea></div>
                        <p style="font-size:12px; color:var(--text-secondary);">Your identity will not be shared with the management.</p>
                    `;

                case 'assignShift':
                    const staffOpts = (window.allStaff || []).map(s => `<option value="${s.id}|${s.name}|${s.role}">${s.name} (${s.role})</option>`).join('');
                    return `
                        <div class="form-group"><label>Staff Member *</label>
                            <select id="shift-staff" class="form-control" required><option value="">-- Select Staff --</option>${staffOpts}</select>
                        </div>
                        <div class="form-group"><label>Date *</label><input type="date" id="shift-date" class="form-control" required></div>
                        <div class="form-group"><label>Start Time *</label><input type="time" id="shift-start" class="form-control" required></div>
                        <div class="form-group"><label>End Time *</label><input type="time" id="shift-end" class="form-control" required></div>
                    `;
                
                case 'maintenanceLog':
                    const eq = allEquipment.find(e => e.id === item);
                    if (!eq) return '<p>Equipment not found.</p>';
                    
                    let logsHtml = '<p style="color:var(--text-secondary); font-size:13px;">No maintenance history.</p>';
                    if (eq.maintenanceLog && eq.maintenanceLog.length > 0) {
                        logsHtml = `<table class="table" style="margin-bottom:16px;"><thead><tr><th>Date</th><th>Description</th><th>Cost</th><th>Tech</th></tr></thead><tbody>` + 
                        eq.maintenanceLog.map(l => `<tr><td>${new Date(l.date).toLocaleDateString()}</td><td>${l.description}</td><td>₹${l.cost}</td><td>${l.technician}</td></tr>`).join('') + 
                        `</tbody></table>`;
                    }

                    return `
                        <div style="margin-bottom:20px;">
                            <h4 style="margin-bottom:8px;">History for ${eq.name}</h4>
                            ${logsHtml}
                        </div>
                        <h4 style="margin-bottom:12px; border-top:1px solid #eee; padding-top:12px;">Add New Entry</h4>
                        <div class="form-group"><label>Date</label><input type="date" id="maint-date" class="form-control" value="${new Date().toISOString().split('T')[0]}"></div>
                        <div class="form-group"><label>Description</label><input type="text" id="maint-desc" class="form-control" placeholder="e.g., Belt replacement"></div>
                        <div style="display:flex; gap:12px;"><div class="form-group" style="flex:1"><label>Cost (₹)</label><input type="number" id="maint-cost" class="form-control"></div><div class="form-group" style="flex:1"><label>Technician</label><input type="text" id="maint-tech" class="form-control"></div></div>
                    `;

                default:
                    return `<p>This is the content for the ${type} modal. In a real app, this would contain complex form logic and API calls.</p>`;
            }
        }

        function getModalFooter(type, item) {
             switch (type) {
                case 'addMember': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('save', 'Member')">Save Member</button>`;
                case 'editMember': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-danger" style="margin-left: auto;" onclick="handleAction('delete', '${item}')">Delete</button><button type="button" class="btn btn-primary" onclick="handleAction('save', 'Changes')">Save Changes</button>`;
                case 'renewMember': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('renew', '${item}')">Renew Membership</button>`;
                case 'freezeMember': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-danger" onclick="handleAction('freeze', '${item}')">Freeze Account</button>`;
                case 'sendMessage': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('send', 'Message')">Send Message</button>`;
                case 'createClass': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('save', 'Class')">Create Class</button>`;
                case 'addEquipment': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('save', 'Equipment')">Add Equipment</button>`;
                case 'addStaff': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('save', 'Staff Member')">Send Invite</button>`;
                case 'recordPayment': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('record', 'Payment')">Record Payment</button>`;
                case 'openPOS': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-danger" onclick="closeModal()">Clear Cart</button><button type="button" class="btn btn-success" onclick="handleAction('complete', 'Sale')">Complete Sale</button>`;
                case 'scheduleMaintenance': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('schedule', 'Maintenance')">Schedule</button>`;
                case 'sendBulkSMS': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button id="send-bulk-sms-confirm" type="button" class="btn btn-primary" onclick="handleAction('sendBulkSMS')">Send to ${selectedMembers ? selectedMembers.size : 0} Members</button>`;
                case 'viewLeadDetail': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>`;
                case 'campaignBuilder': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('send', 'Campaign')">Send to 12 Leads</button>`;
                case 'convertToMember': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-success" onclick="handleAction('convert', '${item}')">Convert & Save</button>`;
                case 'razorpaySettings': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button><button type="button" class="btn btn-primary" onclick="handleAction('save', 'Integration')">Save Settings</button>`;
                case 'importMembers': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleImportConfirm()">Import Members</button>`;
                case 'checkin': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('checkin', 'Attendance')">Confirm Check-in</button>`;
                case 'addTask': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('save', 'Task')">Create Task</button>`;
                case 'profile': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('save', 'Profile')">Update Profile</button>`;
                case 'forgotPassword': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('sendResetLink')">Send Link</button>`;
                case 'resetPassword': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('confirmResetPassword')">Update Password</button>`;
                case 'submitFeedback': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('submitFeedback')">Submit</button>`;
                case 'assignShift': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('assignShift')">Assign</button>`;
                case 'maintenanceLog': return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button><button type="button" class="btn btn-primary" onclick="handleAction('addMaintenanceLog', '${item}')">Add Entry</button>`;
                default: return `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="button" class="btn btn-primary" onclick="handleAction('${type}', '${item}')">Confirm</button>`;
            }
        }
        
        // ============ ACTION HANDLERS (Stubs for real backend work) ============
        async function handleAction(action, data) {
            let message = `Action: ${action} on ${data} executed (Backend not implemented).`;
            let type = 'info';

            const successMessages = {
                'save': { msg: `${data} saved successfully!`, type: 'success' },
                'delete': { msg: `${data} deleted successfully.`, type: 'success' },
                'freeze': { msg: `${data} account frozen. Member notified via SMS.`, type: 'success' },
                'record': { msg: `Payment recorded! Invoice marked as PAID.`, type: 'success' },
                'complete': { msg: `Sale complete! Total: ₹2,356. Receipt printed.`, type: 'success' },
                'schedule': { msg: `Maintenance scheduled. Vendor notified.`, type: 'success' },
                'convert': { msg: `Lead ${data} successfully converted to Member!`, type: 'success' },
                'send': { msg: `${data} sent successfully!`, type: 'success' },
                'renew': { msg: `${data} membership renewed for 12 months!`, type: 'success' },
                'export': { msg: `Data exported successfully!`, type: 'success' },
            };

            if (successMessages[action]) {
                message = successMessages[action].msg;
                type = successMessages[action].type;
            }

            switch (action) {
                case 'save':
                    if (data === 'Member') {
                        // Collect data from modal inputs
                        const payload = {
                            firstName: document.getElementById('new-mem-firstname').value,
                            lastName: document.getElementById('new-mem-lastname').value,
                            email: document.getElementById('new-mem-email').value,
                            phone: document.getElementById('new-mem-phone').value,
                            plan: document.getElementById('new-mem-plan').value,
                            startDate: document.getElementById('new-mem-start').value
                        };

                        // Send to Backend
                        try {
                            const res = await fetch(`${API_BASE_URL}/members`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (res.ok) {
                                message = 'Member added successfully!';
                                type = 'success';
                                fetchMembers(); // Refresh list
                            } else {
                                throw new Error('Failed to save');
                            }
                        } catch (e) {
                            message = 'Error saving member';
                            type = 'error';
                        }
                    }
                    else if (data === 'Class') {
                        const payload = {
                            name: document.querySelector('#modal-body input[type="text"]').value,
                            trainer: document.querySelector('#modal-body select').value,
                            time: document.querySelector('#modal-body input[type="time"]').value
                        };
                        try {
                            await fetch(`${API_BASE_URL}/classes`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            message = 'Class created successfully!';
                            type = 'success';
                            fetchClasses();
                        } catch(e) { message = 'Error creating class'; type = 'error'; }
                    }
                    else if (data === 'Staff Member') {
                        const payload = {
                            name: document.getElementById('new-staff-name').value,
                            role: document.getElementById('new-staff-role').value,
                            email: document.getElementById('new-staff-email').value,
                            phone: document.getElementById('new-staff-phone').value
                        };
                        try {
                            await fetch(`${API_BASE_URL}/staff`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            message = 'Staff added successfully!';
                            type = 'success';
                            fetchStaff();
                        } catch(e) { message = 'Error adding staff'; type = 'error'; }
                    }
                    else if (data === 'Equipment') {
                        // Mock data collection from modal
                        const payload = {
                            name: 'New Equipment', // In real app, get from input
                            category: 'Strength',
                            purchaseDate: '2025-01-01',
                            nextMaintenance: '2025-06-01'
                        };
                        try {
                            await fetch(`${API_BASE_URL}/equipment`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify(payload) });
                            message = 'Equipment added!'; type = 'success'; fetchEquipment();
                        } catch(e) { message = 'Error adding equipment'; type = 'error'; }
                    }
                    else if (data === 'Payment') {
                        const payload = {
                            memberName: 'John Doe', // Mock
                            plan: 'Premium',
                            amount: 2999,
                            status: 'Paid',
                            dueDate: '2025-12-12'
                        };
                        try {
                            await fetch(`${API_BASE_URL}/invoices`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify(payload) });
                            message = 'Payment recorded!'; type = 'success'; fetchInvoices();
                        } catch(e) { message = 'Error recording payment'; type = 'error'; }
                    }
                    else if (data === 'Task') {
                        const payload = {
                            title: document.getElementById('new-task-title').value,
                            assignedTo: document.getElementById('new-task-assign').value,
                            priority: document.getElementById('new-task-priority').value,
                            dueDate: document.getElementById('new-task-date').value,
                            status: 'Pending'
                        };
                        try {
                            await fetch(`${API_BASE_URL}/tasks`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify(payload) });
                            message = 'Task created!'; type = 'success'; fetchTasks();
                        } catch(e) { message = 'Error creating task'; type = 'error'; }
                    }
                    else if (data === 'Profile') {
                        const name = document.getElementById('profile-name').value;
                        const pass = document.getElementById('profile-pass').value;
                        const avatarUrl = document.getElementById('profile-avatar').value;
                        const avatarFile = document.getElementById('profile-avatar-file').files[0];
                        
                        let finalAvatar = avatarUrl;
                        if (avatarFile) {
                            // Convert file to base64
                            finalAvatar = await new Promise(resolve => {
                                const reader = new FileReader();
                                reader.onload = e => resolve(e.target.result);
                                reader.readAsDataURL(avatarFile);
                            });
                        }

                        const payload = { name, avatar: finalAvatar };
                        if (pass) payload.password = pass;

                        try {
                            await fetch(`${API_BASE_URL}/profile`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify(payload) });
                            message = 'Profile updated!'; type = 'success'; fetchProfile();
                        } catch(e) { message = 'Error updating profile'; type = 'error'; }
                    }
                    break;

                case 'delete':
                    if (confirm(`Are you sure you want to delete ${data}?`)) {
                        try {
                            const res = await fetch(`${API_BASE_URL}/members/${encodeURIComponent(data)}`, { method: 'DELETE' });
                            if (res.ok) {
                                message = 'Member deleted successfully';
                                type = 'success';
                                fetchMembers();
                                fetchDashboardStats();
                            } else throw new Error('Delete failed');
                        } catch (e) { message = 'Error deleting member'; type = 'error'; }
                    } else { return; } // Cancelled
                    break;

                case 'deleteStaff':
                    if (confirm(`Are you sure you want to delete this staff member?`)) {
                        try {
                            const res = await fetch(`${API_BASE_URL}/staff/${encodeURIComponent(data)}`, { method: 'DELETE' });
                            if (res.ok) {
                                message = 'Staff member deleted';
                                type = 'success';
                                fetchStaff();
                            } else throw new Error('Delete failed');
                        } catch (e) { message = 'Error deleting staff'; type = 'error'; }
                    } else { return; }
                    break;

                case 'sendBulkSMS':
                    {
                        const count = selectedMembers ? selectedMembers.size : 0;
                        if (count === 0) {
                            message = 'No members selected to send messages.';
                            type = 'warning';
                        } else {
                            message = `${count} messages queued for sending.`;
                            type = 'success';
                            selectedMembers.clear();
                            document.querySelectorAll('.member-select').forEach(cb => cb.checked = false);
                            const selectAll = document.getElementById('select-all-members');
                            if (selectAll) selectAll.checked = false;
                            updateBulkSendUI();
                        }
                    }
                    break;
                
                case 'completeTask':
                    try {
                        await fetch(`${API_BASE_URL}/tasks/${data}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ status: 'Completed' }) });
                        message = 'Task completed!'; type = 'success'; fetchTasks();
                    } catch(e) { message = 'Error updating task'; type = 'error'; }
                    break;

                case 'addMaintenanceLog':
                    const mDate = document.getElementById('maint-date').value;
                    const mDesc = document.getElementById('maint-desc').value;
                    const mCost = document.getElementById('maint-cost').value;
                    const mTech = document.getElementById('maint-tech').value;
                    
                    if(!mDesc) { showNotification('Description required', 'warning'); return; }

                    try {
                        await fetch(`${API_BASE_URL}/equipment/${data}/maintenance`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ date: mDate, description: mDesc, cost: mCost, technician: mTech }) });
                        message = 'Log added!'; type = 'success'; fetchEquipment();
                    } catch(e) { message = 'Error adding log'; type = 'error'; }
                    break;
            }

            showNotification(message, type);
            closeModal();
        }

        // ============ RUN INITIALIZATION ============
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // ============ FEATURES - FILTERS & BULK ACTIONS ============
        function filterMembers() {
            const searchValue = document.getElementById('search-members')?.value?.toLowerCase() || '';
            const statusValue = document.getElementById('filter-members-status')?.value || '';
            
            const memberRows = document.querySelectorAll('#view-members table tbody tr');
            memberRows.forEach(row => {
                // Corrected selectors: name is 2nd child, phone is 3rd
                const name = row.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';
                const phone = row.querySelector('td:nth-child(3)')?.textContent?.toLowerCase() || '';
                const status = row.querySelector('td:nth-child(4)')?.textContent?.toLowerCase() || '';
                
                const matchesSearch = name.includes(searchValue) || phone.includes(searchValue);
                const matchesStatus = !statusValue || status.includes(statusValue);
                
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
        }

        function handleBulkAction(action) {
            switch(action) {
                case 'export':
                    alert('Members list exported as CSV (members_' + new Date().toISOString().split('T')[0] + '.csv)');
                    break;
                case 'sendBulkSMS':
                    console.log('handleBulkAction sendBulkSMS - selectedMembers size', selectedMembers ? selectedMembers.size : 0);
                    if (!selectedMembers || selectedMembers.size === 0) {
                        showNotification('Please select members to send SMS to.', 'warning', 2500);
                    } else {
                        showModal('sendBulkSMS');
                    }
                    break;
                case 'delete':
                    if(confirm('Delete selected members? This cannot be undone.')) {
                        alert('Selected members deleted.');
                    }
                    break;
            }
        }

        // ============ IMPORT MEMBERS (Excel/CSV + Images) ============
        // Helper to normalize names -> id
        function normalizeMemberId(name, phone) {
            if (!name && !phone) return `m-${Date.now()}`;
            let id = (name || phone || '').toString().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            if (!id) id = `m-${Date.now()}`;
            // Ensure uniqueness
            let base = id;
            let i = 1;
            while (document.querySelector(`tr[data-member-id="${id}"]`)) {
                id = `${base}-${i++}`;
            }
            return id;
        }

        async function handleImportConfirm() {
            console.log('handleImportConfirm called');
            const excelInput = document.getElementById('import-members-excel');
            const imagesInput = document.getElementById('import-members-images');
            const file = excelInput?.files?.[0];
            const images = imagesInput?.files || [];
            if (!file) {
                showNotification('Please choose an Excel or CSV file to import.', 'warning', 2200);
                return;
            }
            showNotification('Import started. Parsing file...', 'info', 2000);
            try {
                const members = await parseExcelOrCSV(file);
                // parse images
                const imagesMap = await readImagesAsDataUrls(images);
                // For each member, setup id and image if available
                members.forEach(m => {
                    m.id = normalizeMemberId(m.name || `${m.firstName || ''} ${m.lastName || ''}`, m.phone);
                    // match by filename if provided
                    if (m.image_filename && imagesMap[m.image_filename]) {
                        m.image = imagesMap[m.image_filename];
                    } else if (m.phone && imagesMap[m.phone]) {
                        m.image = imagesMap[m.phone];
                    }
                    addMemberRow(m);
                });
                showNotification(`${members.length} members imported.`, 'success', 2500);
                closeModal();
            } catch (err) {
                console.error('Import error', err);
                showNotification('Import failed: ' + (err.message || ''), 'danger', 3200);
            }
        }

        function readImagesAsDataUrls(fileList) {
            const map = {};
            const promises = [];
            for (let file of fileList) {
                const name = file.name;
                const p = new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        map[name] = e.target.result; // dataURL
                        // Also store by phone (strip extension)
                        const nameWithoutExt = name.replace(/\.[^.]+$/, '');
                        map[nameWithoutExt] = e.target.result;
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
                promises.push(p);
            }
            return Promise.all(promises).then(() => map);
        }

        async function parseExcelOrCSV(file) {
            const name = (file && file.name) || '';
            const isCSV = name.toLowerCase().endsWith('.csv');
            if (isCSV) {
                const text = await file.text();
                return parseCSV(text);
            }
            // Try to use SheetJS (xlsx) if available
            if (window.XLSX) {
                return await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        try {
                            const data = e.target.result;
                            // Use array buffer if available
                            const arr = new Uint8Array(data);
                            const workbook = XLSX.read(arr, { type: 'array' });
                            const firstSheet = workbook.SheetNames[0];
                            const sheet = workbook.Sheets[firstSheet];
                            const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                            resolve(rows.map(mapRowToMember));
                        } catch (err) { reject(err); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            } else {
                // If no XLSX library, try CSV-ish parsing by reading file as text
                const text = await file.text();
                return parseCSV(text);
            }
        }

        function parseCSV(text) {
            // Simple CSV parse (commas, supports quoted fields)
            const lines = text.split(/\r?\n/).filter(Boolean);
            if (lines.length === 0) return [];
            const headers = lines[0].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
            const rows = lines.slice(1).map(l => l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, '')));
            return rows.map(cols => {
                const row = {};
                cols.forEach((c, i) => { row[headers[i]] = c; });
                return mapRowToMember(row);
            });
        }

        function mapRowToMember(row) {
            // Map common columns to our structure
            const name = row.name || `${row.first || ''} ${row.last || ''}` || row.fullname || row.full_name || row['member name'] || row['name'] || '';
            const phone = row.phone || row.mobile || row['phone number'] || '';
            const plan = row.plan || row.membership || row['plan'] || '';
            const expiry = row.expiry || row['expiry date'] || row.expiration || row.expire || '';
            const status = (row.status || '').toString();
            const engagement = row.engagement || '';
            const image_filename = row.image_filename || row.image || row['image file'] || '';
            return { name, phone, plan, expiry, status, engagement, image_filename };
        }

        function addMemberRow(member) {
            const tbody = document.getElementById('members-table-body');
            if (!tbody) return;
            const tr = document.createElement('tr');
            tr.setAttribute('data-member-id', member.id || normalizeMemberId(member.name, member.phone));
            tr.addEventListener('click', () => openDetailPanel('member', member));
            // Build cells
            const checkboxTd = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'member-select';
            checkbox.dataset.memberId = tr.dataset.memberId;
            checkbox.onclick = function(e) { e.stopPropagation(); toggleSelectMember(this); };
            checkboxTd.appendChild(checkbox);
            tr.appendChild(checkboxTd);

            const nameTd = document.createElement('td');
            if (member.image) {
                const img = document.createElement('img');
                img.src = member.image;
                img.style.width = '28px';
                img.style.height = '28px';
                img.style.borderRadius = '50%';
                img.style.marginRight = '8px';
                nameTd.appendChild(img);
            }
            nameTd.appendChild(document.createTextNode(member.name || 'Member')); 
            tr.appendChild(nameTd);

            const phoneTd = document.createElement('td');
            phoneTd.textContent = member.phone || '';
            tr.appendChild(phoneTd);

            const statusTd = document.createElement('td');
            const statusSpan = document.createElement('span');
            statusSpan.className = 'status-badge ' + (member.status ? 'status-' + member.status.toLowerCase() : 'status-active');
            statusSpan.textContent = member.status || 'Active';
            statusTd.appendChild(statusSpan);
            tr.appendChild(statusTd);

            const planTd = document.createElement('td');
            planTd.textContent = member.plan || '';
            tr.appendChild(planTd);

            const expiryTd = document.createElement('td');
            expiryTd.textContent = member.expiry || '';
            tr.appendChild(expiryTd);

            const engagementTd = document.createElement('td');
            engagementTd.innerHTML = `<span style="color: var(--success); font-weight:700;">${member.engagement || ''}</span>`;
            tr.appendChild(engagementTd);

            const actionsTd = document.createElement('td');
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-sm btn-secondary';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', (e) => { e.stopPropagation(); showModal('editMember', member); });
            actionsTd.appendChild(editBtn);
            tr.appendChild(actionsTd);

            tbody.appendChild(tr);
        }

        function addQuickStat(label, value) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h3>${label}</h3>
                <div class="card-value">${value}</div>
            `;
            return card;
        }

        // ============ KEYBOARD SHORTCUTS ============
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + N = New Member
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showModal('addMember');
            }
            // Ctrl/Cmd + F = Focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                const searchBox = document.getElementById('search-members');
                if (searchBox) searchBox.focus();
            }
            // Escape = Close modal (already handled)
        });

        // ============ NOTIFICATION SYSTEM ============
        function showNotification(message, type = 'info', duration = 3000) {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: var(--${type === 'error' ? 'danger' : type});
                color: white;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, duration);
        }

        // ============ MEMBER SELECTION & BULK ACTIONS ============
        // Global set of selected member ids
        let selectedMembers = new Set();

        function toggleSelectMember(checkbox) {
            const id = checkbox.dataset.memberId;
            if (!id) return;
            if (checkbox.checked) selectedMembers.add(id);
            else selectedMembers.delete(id);
            console.log('toggleSelectMember', id, checkbox.checked, 'selectedCount', selectedMembers.size);
            updateBulkSendUI();
        }

        function updateBulkSendUI() {
            const btn = document.getElementById('bulk-send-sms-btn');
            if (!btn) return;
            const count = selectedMembers.size;
            console.log('updateBulkSendUI', selectedMembers.size);
            btn.disabled = count === 0;
            btn.textContent = count ? `Send SMS (${count})` : 'Send SMS';
        }

        function toggleSelectAllMembers(checkbox) {
            const checked = checkbox.checked;
            const checkboxes = document.querySelectorAll('.member-select');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                const id = cb.dataset.memberId;
                if (!id) return;
                if (checked) selectedMembers.add(id);
                else selectedMembers.delete(id);
            });
            updateBulkSendUI();
        }
    </script>
</body>
</html>